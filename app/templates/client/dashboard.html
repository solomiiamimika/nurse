{% extends "base.html" %}
{% block content %}
<div class="client-dashboard">
    <h2>Панель клієнта</h2>
    <div class="dashboard-options">
        <button ><a href="{{ url_for('auth.logout') }}"></a></button>"
        <button id="location-btn" class="btn btn-info">
            {% if current_user.location_approved %}
                Оновити моє місцезнаходження
            {% else %}
                Надати доступ до місцезнаходження
            {% endif %}
        </button>
        <div id="status" style="margin-top: 10px; min-height: 20px; color: green;"></div>
    </div>
    
    <div id="map-container" style="height: 500px; width: 100%; margin-top: 20px; border: 2px solid #ddd;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Глобальні змінні
    let map, userMarker, nurseMarkers = [];
    
    // Функція для оновлення статусу
    function updateStatus(message, isError = false) {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.style.color = isError ? 'red' : 'green';
        console.log(message);
    }

    // Ініціалізація карти
    function initMap() {
        try {
            updateStatus("Спробуємо ініціалізувати карту...");
            
            // Створення карти
            map = L.map('map-container').setView([50.4501, 30.5234], 12);
            
            // Додаємо базовий шар
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            updateStatus("Карта успішно завантажена");
            
            // Автоматичне завантаження даних
            loadInitialData();
            
        } catch (error) {
            updateStatus("Помилка ініціалізації: " + error.message, true);
            console.error(error);
        }
    }
    
    // Завантаження початкових даних
    function loadInitialData() {
        // Координати користувача
        {% if current_user.latitude and current_user.longitude %}
            updateUserMarker({{ current_user.latitude }}, {{ current_user.longitude }});
        {% endif %}
        
        // Список медсестер
        loadNurses();
    }
    
    // Оновлення маркера користувача
    function updateUserMarker(lat, lng) {
        try {
            if (userMarker) map.removeLayer(userMarker);
            
            userMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'user-marker',
                    html: '<div style="background: blue; border-radius: 50%; width: 20px; height: 20px;"></div>',
                    iconSize: [20, 20]
                })
            }).addTo(map);
            
            map.setView([lat, lng], 12);
            updateStatus("Місцезнаходження оновлено");
            
        } catch (error) {
            updateStatus("Помилка оновлення маркера", true);
            console.error(error);
        }
    }
    
    // Завантаження медсестер
    async function loadNurses() {
        try {
            updateStatus("Завантаження медсестер...");
            
            const response = await fetch('{{ url_for("client.get_nurses_locations") }}');
            if (!response.ok) throw new Error("Помилка сервера");
            
            const nurses = await response.json();
            
            // Очищаємо старі маркери
            nurseMarkers.forEach(m => map.removeLayer(m));
            nurseMarkers = [];
            
            // Додаємо нові маркери
            nurses.forEach(nurse => {
                const marker = L.marker([nurse.lat, nurse.lng], {
                    icon: L.divIcon({
                        className: 'nurse-marker',
                        html: `<div style="background: ${nurse.online ? 'green' : 'red'}; 
                              border-radius: 50%; width: 20px; height: 20px;"></div>`,
                        iconSize: [20, 20]
                    })
                }).addTo(map);
                
                marker.bindPopup(`<b>${nurse.name}</b><br>Статус: ${nurse.online ? 'Доступна' : 'Недоступна'}`);
                nurseMarkers.push(marker);
            });
            
            updateStatus(`Знайдено ${nurses.length} медсестер`);
            
        } catch (error) {
            updateStatus("Помилка завантаження: " + error.message, true);
            console.error(error);
        }
    }
    
    // Обробник кнопки геолокації
    async function handleLocation() {
        try {
            updateStatus("Визначення вашого місцезнаходження...");
            
            // Тестовий режим для localhost
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                updateStatus("Тестовий режим: використовуємо координати Києва");
                updateUserMarker(50.4501, 30.5234);
                return;
            }
            
            if (!navigator.geolocation) {
                throw new Error("Браузер не підтримує геолокацію");
            }
            
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000
                });
            });
            
            const {latitude, longitude} = position.coords;
            updateUserMarker(latitude, longitude);
            
            // Відправка на сервер
            const response = await fetch('{{ url_for("client.update_location") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({latitude, longitude})
            });
            
            if (!response.ok) throw new Error("Помилка сервера");
            
            const result = await response.json();
            if (!result.success) throw new Error(result.message || "Помилка оновлення");
            
            updateStatus("Локація збережена успішно");
            loadNurses();
            
        } catch (error) {
            updateStatus("Помилка: " + error.message, true);
            console.error(error);
        }
    }
    
    // Ініціалізація після завантаження сторінки
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM повністю завантажений");
        initMap();
        
        const btn = document.getElementById('location-btn');
        console.log("Знайдено кнопку:", btn);
        
        if (btn) {
            btn.addEventListener('click', handleLocation);
            console.log("Обробник кліку додано до кнопки");
        } else {
            console.error("Кнопка не знайдена!");
        }
    });
    
    // Додатковий спосіб ініціалізації для надійності
    if (document.readyState === 'complete') {
        initMap();
    }
</script>
{% endblock %}