{% extends "base.html" %} {% block content %}
<div class="client-dashboard">
  <h2>Hi, {{ current_user.full_name if current_user.full_name else current_user.username}}!</h2>
  <h5 style="text-align: center">client dashboard</h5>

  <div class="dashboard-options" style="margin-bottom: 20px">
    <form
      action="{{url_for('auth.logout')}}"
      method="post"
      style="display: inline"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <button type="submit" class="btn btn-info">
        <i class="fas fa-sign-out-alt"></i> Exit
      </button>
    </form>

    <a href="{{ url_for('client.appointments') }}" class="btn btn-info">
      <i class="fas fa-calendar"></i> Calendar (My appointments)
    </a>

    <button id="location-btn" class="btn btn-info">
      <i class="fas fa-map-marker-alt"></i> Update my location
    </button>
    <a href="{{ url_for('client.profile') }}" class="btn btn-info">
      <i class="fa-solid fa-circle-user"></i> Profile
    </a>
    <div
      id="status-message"
      class="mt-2 small"
      style="display: inline-block; margin-left: 10px"
    ></div>
  </div>
  <form class="top-search-bar" method="GET" action="{{ request.path }}">
    <input
      type="text"
      name="q"
      value="{{ search_query|default('') }}"
      placeholder="Enter the provider’s name or the service name..."
      class="search-input"
    />

    <button type="submit" class="search-btn">
      <i class="fas fa-search"></i> Find
    </button>
  </form>
</div>

<div class="premium-box mt-4">
  <div class="row g-4">
    <div class="col-md-8">
      <h5 class="premium-title">Nearby services map</h5>
      <div id="nursesMap" style="height: 480px; width: 100%"></div>
    </div>

    <div class="col-md-4">
      <h5 class="premium-title">Search results</h5>

      <div style="height: 480px; overflow-y: auto; padding-right: 10px">
        {% if nurses %} {% for nurse in nurses %}
        <div class="card mb-3 nurse-item">
          <div class="card-body">
            <h6>{{ nurse.full_name or nurse.user_name }}</h6>

            {% if nurse.online %}
            <span class="badge badge-online">Online</span>
            {% else %}
            <span class="badge badge-offline">Offline</span>
            {% endif %}

            <p class="small text-muted mt-2">
              <i class="fas fa-map-marker-alt"></i> {{ nurse.address or
              'Location not found' }}
            </p>

            <button
              class="btn-premium mt-2"
              onclick="openChat('{{ nurse.id }}','{{ nurse.full_name }}')"
            >
              Chat
            </button>

            <button
              class="btn-premium-secondary mt-2"
              onclick="openBookingModal('{{ nurse.id }}','{{ nurse.full_name }}')"
            >
              Book now
            </button>
          </div>
        </div>
        {% endfor %} {% else %}
        <div class="alert alert-warning">No services found.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">
          Appointment with: <span id="bookingNurseName"></span>
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="bookingForm">
          <input type="hidden" id="nurseIdInput" name="nurse_id" />

          <div class="mb-3">
            <label for="serviceSelect" class="form-label"
              >Choose your service</label
            >
            <select class="form-select" id="serviceSelect" required></select>
          </div>

          <div class="mb-3">
            <label for="appointmentDate" class="form-label"
              >Date and time</label
            >
            <input
              type="datetime-local"
              class="form-control"
              id="appointmentDate"
              required
            />
          </div>

          <div class="mb-3">
            <label for="appointmentNotes" class="form-label">Comment</label>
            <textarea
              class="form-control"
              id="appointmentNotes"
              rows="2"
            ></textarea>
          </div>

          <div id="bookingError" class="alert alert-danger d-none"></div>
          <div id="bookingSuccess" class="alert alert-success d-none"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancell
        </button>
        <button type="button" class="btn btn-success" id="submitBookingBtn">
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/uk.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>

<script>
  let currentAppointmentId = null;
  const stripe = Stripe("{{ stripe_public_key }}");
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  document.addEventListener("DOMContentLoaded", function () {
    const calendarEl = document.getElementById("calendar");
    const isMobile = window.innerWidth < 768;

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: isMobile ? "listWeek" : "dayGridMonth",
      
      // ВИПРАВЛЕННЯ ТУТ:
      // На мобільному ставимо висоту 75% від екрану (75vh), щоб місяць "розкрився".
      // На ПК залишаємо auto, щоб підлаштовувалось під вміст.
      height: isMobile ? '75vh' : 'auto', 
      
      headerToolbar: {
        left: "prev,next", 
        center: "title",
        right: isMobile ? "dayGridMonth,listWeek" : "dayGridMonth,timeGridWeek,timeGridDay",
      },
      locale: "en",
      events: "/client/get_appointments",
      
      // Додаткове налаштування для мобільного місяця, щоб події виглядали крапочками, якщо їх багато
      dayMaxEvents: true, 

      eventClick: function (info) {
        currentAppointmentId = info.event.id;
        const props = info.event.extendedProps;

        document.getElementById("detailServiceName").textContent = props.service_name;
        document.getElementById("detailDateTime").textContent = info.event.start.toLocaleString("uk-UA");
        document.getElementById("detailStatus").textContent = getStatusText(props.status);
        document.getElementById("detailNotes").textContent = props.notes || "Немає приміток";
        document.getElementById("detailAmount").textContent = props.amount || "0.00";

        const paymentSection = document.getElementById("paymentSection");
        const paymentStatus = document.getElementById("paymentStatus");

        if (props.status === "scheduled" || props.status === "confirmed") {
          paymentSection.style.display = "block";
          paymentStatus.style.display = "none";
        } else {
          paymentSection.style.display = "none";
          if (props.status === "confirmed_paid") {
            paymentStatus.style.display = "block";
            paymentStatus.className = "alert alert-success";
            paymentStatus.textContent = "Paid";
          }
        }

        const actionsContainer = document.getElementById("appointmentActions");
        actionsContainer.innerHTML = "";

        if (props.status === "scheduled") {
          actionsContainer.innerHTML = `
            <button class="btn btn-danger" onclick="cancelAppointment(${info.event.id})">
                Cancel appointment
            </button>
          `;
        }
        checkReviewStatus(currentAppointmentId);
        const modal = new bootstrap.Modal(document.getElementById("appointmentDetailsModal"));
        modal.show();
      },
    });
    calendar.render();

    // ... (решта коду кнопок payNowBtn, newAppointmentBtn без змін) ...
    
    // Кнопка створення запису
    document.getElementById("newAppointmentBtn").addEventListener("click", function () {
        fetch("/client/get_nurses_for_appointment")
          .then((response) => response.json())
          .then((nurses) => {
            const formHtml = `
                <form id="appointmentForm">
                    <div class="mb-3">
                        <label class="form-label">Nurse</label>
                        <select class="form-select" id="nurseSelect">
                            ${nurses.map((n) => `<option value="${n.id}">${n.name}</option>`).join("")}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Make an appointment</button>
                </form>
            `;
            document.getElementById("appointmentFormContainer").innerHTML = formHtml;
            const modal = new bootstrap.Modal(document.getElementById("newAppointmentModal"));
            modal.show();
          });
      });

    // Оплата
    document.getElementById("payNowBtn").addEventListener("click", function () {
      if (!currentAppointmentId) return;
      const btn = this;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      fetch("/client/create_payment_session", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({ appointment_id: currentAppointmentId }),
      })
        .then((response) => {
             if (!response.ok) throw new Error("Network error");
             return response.json();
        })
        .then((data) => stripe.redirectToCheckout({ sessionId: data.sessionId }))
        .then((result) => {
          if (result && result.error) {
            showPaymentError(result.error.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-credit-card"></i> Make a payment now';
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showPaymentError(error.message);
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-credit-card"></i> Make a payment now';
        });
    });
  });

  function getStatusText(status) {
    const statuses = {
      scheduled: "Scheduled",
      confirmed: "Approved",
      completed: "Completed",
      cancelled: "Cancelled",
      confirmed_paid: "Paid and confirmed",
    };
    return statuses[status] || status;
  }

  function showPaymentError(message) {
    const paymentStatus = document.getElementById("paymentStatus");
    paymentStatus.style.display = "block";
    paymentStatus.className = "alert alert-danger";
    paymentStatus.textContent = "Payment error:" + message;
  }

  function cancelAppointment(appointmentId) {
    if (confirm("Are you sure you want to cancel this appointment?")) {
      fetch("/client/cancel_appointment", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({ appointment_id: appointmentId }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            location.reload();
          } else {
            alert("Error: " + data.message);
          }
        });
    }
  }

  // Функції відгуків (залишив без змін, скорочено для зручності копіювання)
  function checkReviewStatus(appointmentId) {
    fetch(`/client/can_review/${appointmentId}`)
      .then((r) => r.json())
      .then((data) => {
        const els = {
            noReview: document.getElementById("noReviewMessage"),
            existing: document.getElementById("existingReview"),
            form: document.getElementById("reviewForm")
        };
        if (data.can_review) {
          els.noReview.style.display = "block";
          els.existing.style.display = "none";
          els.form.style.display = "none";
        } else if (data.review_exists) {
          loadExistingReview(appointmentId);
        } else {
          els.noReview.style.display = "block";
          els.existing.style.display = "none";
          els.form.style.display = "none";
        }
      });
  }

  function loadExistingReview(appointmentId) {
    fetch(`/client/get_review/${appointmentId}`).then(r=>r.json()).then(data => {
        if(data.success){
            document.getElementById("userRating").textContent = `${data.review.rating}/5`;
            document.getElementById("userComment").textContent = data.review.comment || "";
            document.querySelector(".rating-stars").innerHTML = generateRatingStars(data.review.rating);
            document.getElementById("existingReview").style.display = "block";
            document.getElementById("reviewForm").style.display = "none";
            document.getElementById("noReviewMessage").style.display = "none";
        }
    });
  }

  function generateRatingStars(rating) {
    let stars = "";
    for (let i = 1; i <= 5; i++) stars += `<span class="rating-star ${i <= rating ? "filled" : ""}">★</span>`;
    return stars;
  }

  document.getElementById("addReviewBtn").addEventListener("click", () => {
    document.getElementById("reviewForm").style.display = "block";
    document.getElementById("noReviewMessage").style.display = "none";
  });
  
  document.getElementById("editReviewBtn").addEventListener("click", () => {
    document.getElementById("reviewForm").style.display = "block";
    document.getElementById("existingReview").style.display = "none";
    fetch(`/client/get_review/${currentAppointmentId}`).then(r=>r.json()).then(data=>{
        if(data.success) {
            const rb = document.querySelector(`input[name="rating"][value="${data.review.rating}"]`);
            if(rb) rb.checked = true;
            document.getElementById("reviewComment").value = data.review.comment || "";
        }
    });
  });

  document.getElementById("cancelReviewBtn").addEventListener("click", () => {
    document.getElementById("reviewForm").style.display = "none";
    checkReviewStatus(currentAppointmentId);
  });

  document.getElementById("submitReviewBtn").addEventListener("click", function() {
      const rating = document.querySelector('input[name="rating"]:checked')?.value;
      const comment = document.getElementById("reviewComment").value.trim();
      if(!rating) return alert("Please select a rating");
      
      const btn = this;
      btn.disabled = true;
      fetch("/client/leave_review", {
          method: "POST", 
          headers: {"Content-Type": "application/json", "X-CSRFToken": csrfToken},
          body: JSON.stringify({appointment_id: currentAppointmentId, rating, comment})
      }).then(r=>r.json()).then(data=>{
          if(data.success) { alert("Thanks!"); checkReviewStatus(currentAppointmentId); }
          else alert("Error: " + data.message);
      }).finally(()=> btn.disabled=false);
  });
</script>

<style>
  #calendar {
    max-width: 100%;
    margin: 0 auto;
    background-color: white;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }

  /* Стилі для мобільних */
  @media (max-width: 768px) {
    /* Зменшуємо розмір шрифту заголовка, щоб влазив */
    .fc-toolbar-title {
        font-size: 1.1rem !important;
    }
    /* Робимо кнопки компактнішими */
    .fc-button {
        padding: 0.2rem 0.4rem !important;
        font-size: 0.8rem !important;
    }
    /* Вирівнюємо шапку */
    .fc-header-toolbar {
        margin-bottom: 10px !important;
        flex-wrap: wrap; /* Дозволяємо перенос, якщо дуже вузький екран */
        gap: 5px;
    }
    /* Якщо місяць обраний, робимо клітинки трохи меншими за шрифтом */
    .fc-daygrid-day-number {
        font-size: 0.8rem;
        padding: 2px !important;
    }
  }

  .fc-event { cursor: pointer; }
  .fc-event.scheduled { background-color: #ffc107; border-color: #ffc107; }
  .fc-event.confirmed { background-color: #0d6efd; border-color: #0d6efd; }
  .fc-event.confirmed_paid { background-color: #198754; border-color: #198754; }
  .fc-event.completed { background-color: #6c757d; border-color: #6c757d; }
  .fc-event.cancelled { background-color: #dc3545; border-color: #dc3545; text-decoration: line-through; }
</style>
{% endblock %}