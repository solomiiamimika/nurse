{% extends "base.html" %}
{% block content %}
<div class="client-dashboard">
    <h2>Панель клієнта</h2>
    
    <div class="dashboard-options" style="margin-bottom: 20px;">
        <form action="{{url_for('auth.logout')}}" method="post" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-info">
                <i class="fas fa-sign-out-alt"></i> Вийти
            </button>
        </form>
        
        <a href="{{ url_for('client.appointments') }}" class="btn btn-info">
            <i class="fas fa-calendar"></i> Мої записи
        </a>
        
        <button id="location-btn" class="btn btn-info">
            <i class="fas fa-map-marker-alt"></i> Оновити моє місцезнаходження
        </button>

        <div id="status-message" class="mt-2 small" style="display:inline-block; margin-left: 10px;"></div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form action="{{ url_for('client.dashboard') }}" method="get" class="row g-3">
                <div class="col-md-10">
                    <input type="text" name="q" class="form-control" 
                           placeholder="Введіть ім'я медсестри або назву послуги..." 
                           value="{{ search_query|default('') }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-search"></i> Знайти
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Карта медсестер поряд</h5>
                </div>
                <div class="card-body">
                    <div id="nursesMap" style="height: 500px; width: 100%;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4" style="height: 500px; overflow-y: auto;">
                <div class="card-header">
                    <h5>Результати пошуку</h5>
                </div>
                <div class="card-body">
                    {% if nurses %}
                        {% for nurse in nurses %}
                        <div class="card mb-2 nurse-item border-start border-4 border-info">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h6 class="card-title">{{ nurse.full_name or nurse.user_name }}</h6>
                                    {% if nurse.online %}
                                        <span class="badge bg-success">Online</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Offline</span>
                                    {% endif %}
                                </div>
                                
                                <p class="card-text mb-1 small text-muted">
                                    <i class="fas fa-map-marker-alt"></i> 
                                    {{ nurse.address or "Локація не вказана" }}
                                </p>

                                <div class="mt-2 d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="openChat('{{ nurse.id }}', '{{ nurse.full_name or nurse.user_name }}')">
                                        <i class="fas fa-comment"></i> Чат
                                    </button>
                                    <button class="btn btn-sm btn-success" 
                                            onclick="openBookingModal('{{ nurse.id }}', '{{ nurse.full_name or nurse.user_name }}')">
                                        <i class="fas fa-plus"></i> Записатись
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-warning">
                            Медсестер за вашим запитом не знайдено.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Запис до: <span id="bookingNurseName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <input type="hidden" id="nurseIdInput" name="nurse_id">
                    
                    <div class="mb-3">
                        <label for="serviceSelect" class="form-label">Оберіть послугу</label>
                        <select class="form-select" id="serviceSelect" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="appointmentDate" class="form-label">Дата та час</label>
                        <input type="datetime-local" class="form-control" id="appointmentDate" required>
                    </div>

                    <div class="mb-3">
                        <label for="appointmentNotes" class="form-label">Коментар</label>
                        <textarea class="form-control" id="appointmentNotes" rows="2"></textarea>
                    </div>
                    
                    <div id="bookingError" class="alert alert-danger d-none"></div>
                    <div id="bookingSuccess" class="alert alert-success d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                <button type="button" class="btn btn-success" id="submitBookingBtn">Підтвердити</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

<script>
let map;
let userMarker;
let nursesLayer = L.layerGroup();
const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

// --- Функції Статусу ---
function showStatus(message, isError = false) {
    const statusEl = document.getElementById('status-message');
    statusEl.textContent = message;
    statusEl.style.color = isError ? 'red' : 'green';
}

// --- Ініціалізація Карти ---
function initMap() {
    try {
        const clientLat = {{ current_user.latitude | default(50.4501) }};
        const clientLng = {{ current_user.longitude | default(30.5234) }};
        
        map = L.map('nursesMap').setView([clientLat, clientLng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        nursesLayer.addTo(map);

        // Маркер КЛІЄНТА (Я)
        if (clientLat && clientLng) {
            userMarker = L.marker([clientLat, clientLng], {
                icon: L.divIcon({
                    className: 'my-marker',
                    html: '<div style="background-color: blue; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white;"></div>',
                    iconSize: [20, 20]
                }),
                title: 'Я тут'
            }).addTo(map).bindPopup('Ваше розташування');
        }

        loadNursesLocations(); // Завантажуємо медсестер

    } catch (error) {
        console.error("Помилка карти:", error);
    }
}

// --- Завантаження Медсестер на карту ---
async function loadNursesLocations() {
    try {
        nursesLayer.clearLayers();
        const response = await fetch('{{ url_for("client.get_nurses_locations") }}');
        const nurses = await response.json();

        nurses.forEach(nurse => {
            // Створюємо маркер для медсестри
            const marker = L.marker([nurse.lat, nurse.lng], {
                icon: L.divIcon({
                    className: 'nurse-marker',
                    html: `<div style="background-color: ${nurse.online ? '#198754' : 'gray'}; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white;"></div>`,
                    iconSize: [20, 20]
                })
            }).addTo(nursesLayer);

            // Попап з кнопками
            const popupContent = `
                <b>${nurse.name}</b><br>
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary" onclick="openChat('${nurse.id}', '${nurse.name}')">
                        <i class="fas fa-comment"></i> Чат
                    </button>
                    <button class="btn btn-sm btn-success" onclick="openBookingModal('${nurse.id}', '${nurse.name}')">
                        <i class="fas fa-plus"></i> Запис
                    </button>
                </div>
            `;
            marker.bindPopup(popupContent);
        });

    } catch (error) {
        console.error("Помилка завантаження медсестер:", error);
    }
}

// --- Оновлення локації клієнта ---
async function updateLocation() {
    if (!navigator.geolocation) return alert("Геолокація не підтримується");
    
    showStatus("Визначення...");
    navigator.geolocation.getCurrentPosition(async (position) => {
        const {latitude, longitude} = position.coords;
        
        // Оновлюємо маркер на карті
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([latitude, longitude], {
            icon: L.divIcon({
                className: 'my-marker',
                html: '<div style="background-color: blue; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white;"></div>',
                iconSize: [20, 20]
            })
        }).addTo(map);
        map.setView([latitude, longitude], 12);

        // Відправляємо на сервер
        const res = await fetch('{{ url_for("client.update_location") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({latitude, longitude})
        });
        const data = await res.json();
        showStatus(data.success ? "Локація оновлена" : "Помилка", !data.success);
    }, () => showStatus("Доступ до геолокації заборонено", true));
}

// --- Логіка Бронювання (Модальне вікно) ---
function openBookingModal(nurseId, nurseName) {
    document.getElementById('bookingNurseName').textContent = nurseName;
    document.getElementById('nurseIdInput').value = nurseId;
    
    const serviceSelect = document.getElementById('serviceSelect');
    serviceSelect.innerHTML = '<option>Завантаження...</option>';
    
    new bootstrap.Modal(document.getElementById('bookingModal')).show();

    // Завантажуємо послуги
    fetch(`/client/get_nurse_services?nurse_id=${nurseId}`)
        .then(r => r.json())
        .then(services => {
            serviceSelect.innerHTML = '<option value="" selected disabled>Оберіть послугу</option>';
            services.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.name} - ${s.price} грн (${s.duration} хв)`;
                serviceSelect.appendChild(opt);
            });
        });
}

document.getElementById('submitBookingBtn').addEventListener('click', function() {
    const nurseId = document.getElementById('nurseIdInput').value;
    const serviceId = document.getElementById('serviceSelect').value;
    const dateTime = document.getElementById('appointmentDate').value;
    const notes = document.getElementById('appointmentNotes').value;

    fetch('/client/create_appointment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
        body: JSON.stringify({nurse_id: nurseId, service_id: serviceId, date_time: dateTime, notes: notes})
    })
    .then(r => r.json())
    .then(data => {
        if(data.success) {
            alert("Запис створено!");
            location.reload();
        } else {
            alert("Помилка: " + data.message);
        }
    });
});

// --- Старт ---
document.addEventListener('DOMContentLoaded', () => {
    initMap();
    document.getElementById('location-btn').addEventListener('click', updateLocation);
});
</script>
{% endblock %}