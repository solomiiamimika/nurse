{% extends "base.html" %} {% block content %}
<div class="client-profile-page">


  <h2 class="client-profile-title">Profile</h2>

  <!-- FLASH MESSAGES -->
  {% with messages = get_flashed_messages(with_categories=true) %} {% if
  messages %} {% for category, message in messages %}
  <div
    class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show"
  >
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %} {% endif %} {% endwith %}

  <!-- QR BLOCK -->
  <div class="card mb-4 qr-card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Your profile QR Code</span>
      <button id="generateQRBtn" class="btn btn-sm btn-outline-primary">
        Generate
      </button>
    </div>

    <div class="card-body text-center">
      <div id="qrCodeContainer" class="d-none">
        <div id="qrcode" class="mb-3"></div>
        <p class="text-muted small">
          This QR code contains your medical and contact information.
        </p>
        <a id="downloadQR" href="#" class="btn btn-sm btn-success">Download</a>
      </div>

      <div id="qrCodePlaceholder" class="text-muted">
        Click ‚ÄúGenerate‚Äù to create a QR code
      </div>
    </div>
  </div>

  <!-- PHOTO -->
  {% if user.profile_picture %}
  <img
    src="{{ url_for('static', filename='uploads/profile_pictures/' ~ user.profile_picture) }}"
    class="client-avatar"
    alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é"
  />
  {% else %}
  <div class="client-no-photo">Profile photo not uploaded.</div>
  {% endif %}

  <!-- FORM -->
  <form method="POST" enctype="multipart/form-data" class="client-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

    <div class="mb-3">
      <label class="form-label">Full name</label>
      <input
        type="text"
        name="full_name"
        class="form-control"
        value="{{ user.full_name or '' }}"
      />
    </div>

    <div class="mb-3">
      <label class="form-label">Phote number</label>
      <input
        type="text"
        name="phone_number"
        class="form-control"
        value="{{ user.phone_number or '' }}"
      />
    </div>

    <div class="mb-3">
      <label class="form-label">Birth date</label>
      <input
        type="date"
        name="date_birth"
        class="form-control"
        value="{{ formatted_date }}"
      />
    </div>

    <div class="mb-3">
      <label class="form-label">About me</label>
      <textarea name="about_me" class="form-control" rows="3">
{{ user.about_me or '' }}</textarea
      >
    </div>

    <div class="mb-3">
      <label class="form-label">Adress</label>
      <input
        type="text"
        name="address"
        class="form-control"
        value="{{ user.address or '' }}"
      />
    </div>

    <div class="mb-3">
      <label class="form-label">Profile photo:</label>
      <input
        type="file"
        name="profile_picture"
        id="profile_picture"
        class="form-control"
        accept="image/*"
      />
      <div class="form-text">JPG, PNG, and GIF are accepted (max 5MB)</div>
    </div>

    <div class="mb-3">
      <label class="form-label">Download documents</label>
      <input
        type="file"
        name="documents"
        id="documents"
        multiple
        class="form-control"
      />
      <div class="form-text">You can select multiple files (PDF, JPG, PNG)</div>
    </div>

    <button type="submit" class="btn btn-primary">Update</button>
    <a href="{{ url_for('client.dashboard') }}" class="btn btn-secondary mt-2"
      >Back</a
    >
  </form>

  <!-- DOCUMENT LIST -->
  <h4 class="mt-4 mb-3" style="color: var(--green-700)">Your documents</h4>

  {% if user_documents %} {% for doc in user_documents %}
  <div
    class="client-doc-item d-flex justify-content-between align-items-center"
    data-filename="{{ doc }}"
  >
    <a
      href="{{ url_for('static', filename='uploads/documents/' ~ doc) }}"
      target="_blank"
      >üìÑ {{ doc }}</a
    >
    <button class="btn btn-sm btn-danger delete-doc-btn">Delete</button>
  </div>
  {% endfor %} {% else %}
  <div class="alert alert-info">Documents not uploaded.</div>
  {% endif %}
</div>

<!-- –î–æ–¥–∞—î–º–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó QR-–∫–æ–¥—ñ–≤ -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const docsList = document.getElementById("documents-list");
    if (!docsList) return;

    docsList.addEventListener("click", async (event) => {
      if (event.target.classList.contains("delete-doc-btn")) {
        const li = event.target.closest("li");
        const filename = li.getAttribute("data-filename");

        if (!confirm(`Delete document "${filename}"?`)) return;

        try {
          const response = await fetch(
            '{{ url_for("client.delete_document") }}',
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token() }}",
              },
              body: JSON.stringify({ doc_name: filename }),
            }
          );

          const result = await response.json();

          if (result.success) {
            li.remove();
            // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É, —è–∫—â–æ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –±—ñ–ª—å—à–µ –Ω–µ –∑–∞–ª–∏—à–∏–ª–æ—Å—å
            if (docsList.children.length === 0) {
              location.reload();
            }
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          alert("Server error: " + error.message);
        }
      }
    });

    // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ
    const profilePicInput = document.getElementById("profile_picture");
    if (profilePicInput) {
      profilePicInput.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–º—ñ—Ä—É —Ñ–∞–π–ª—É (–º–∞–∫—Å. 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert("The file is too large. The maximum size is 5MB.");
            this.value = "";
          }

          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∏–ø—É —Ñ–∞–π–ª—É
          const validTypes = ["image/jpeg", "image/png", "image/gif"];
          if (!validTypes.includes(file.type)) {
            alert("Only JPG, PNG, and GIF files are allowed.");
            this.value = "";
          }
        }
      });
    }

    // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó QR-–∫–æ–¥—É
    const generateQRBtn = document.getElementById("generateQRBtn");
    if (generateQRBtn) {
      generateQRBtn.addEventListener("click", async function () {
        try {
          // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
          generateQRBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
          generateQRBtn.disabled = true;

          // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞
          const response = await fetch(
            '{{ url_for("client.generate_qr_data") }}'
          );
          const qrData = await response.json();

          // –ì–µ–Ω–µ—Ä—É—î–º–æ QR-–∫–æ–¥
          const qrContainer = document.getElementById("qrcode");
          qrContainer.innerHTML = "";

          // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ toDataURL –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          QRCode.toDataURL(
            qrData.profile_url,
            {
              // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ URL, –∞ –Ω–µ JSON
              width: 200,
              margin: 1,
              color: {
                dark: "#000000",
                light: "#ffffff",
              },
            },
            function (error, url) {
              if (error) {
                console.error(error);
                alert("An error occurred while generating the QR code");
                generateQRBtn.innerHTML = "Generate QR code";
                generateQRBtn.disabled = false;
                return;
              }

              // –°—Ç–≤–æ—Ä—é—î–º–æ img –µ–ª–µ–º–µ–Ω—Ç –∑ QR-–∫–æ–¥–æ–º
              const img = document.createElement("img");
              img.src = url;
              img.alt = "Profile QR code ";
              qrContainer.appendChild(img);

              // –ü–æ–∫–∞–∑—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑ QR-–∫–æ–¥–æ–º
              document
                .getElementById("qrCodeContainer")
                .classList.remove("d-none");
              document
                .getElementById("qrCodePlaceholder")
                .classList.add("d-none");

              // –î–æ–¥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
              const downloadLink = document.getElementById("downloadQR");
              downloadLink.href = url;
              downloadLink.download = "medical-profile-qr.png";

              // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É
              generateQRBtn.innerHTML = "Update QR code";
              generateQRBtn.disabled = false;
            }
          );
        } catch (error) {
          console.error("Error:", error);
          alert("An error occurred while generating the QR code");
          generateQRBtn.innerHTML = "Generate QR code";
          generateQRBtn.disabled = false;
        }
      });
    }
  });
</script>
{% endblock %}
