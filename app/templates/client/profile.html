{% extends "base.html" %} 
{% block content %}
<div class="container mt-4">
  <h2>–ü—Ä–æ—Ñ—ñ–ª—å –∫–ª—ñ—î–Ω—Ç–∞</h2>


  <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—Ö/–ø–æ–º–∏–ª–∫—É -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- QR –∫–æ–¥ —Ç–∞ –∫–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">QR-–∫–æ–¥ –≤–∞—à–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é</h5>
      <button id="generateQRBtn" class="btn btn-sm btn-outline-primary">
        –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ QR-–∫–æ–¥
      </button>
    </div>
    <div class="card-body text-center">
      <div id="qrCodeContainer" class="d-none">
        <div id="qrcode" class="mb-3"></div>
        <p class="text-muted small">
          –¶–µ–π QR-–∫–æ–¥ –º—ñ—Å—Ç–∏—Ç—å –≤–∞—à—É –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é —Ç–∞ –º–µ–¥–∏—á–Ω—ñ –¥–∞–Ω—ñ.
          –õ—ñ–∫–∞—Ä –º–æ–∂–µ –≤—ñ–¥—Å–∫–∞–Ω—É–≤–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –±–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ –≤—Ö–æ–¥—É –≤ —Å–∏—Å—Ç–µ–º—É.
        </p>
        <a id="downloadQR" href="#" class="btn btn-sm btn-success">
          –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ QR-–∫–æ–¥
        </a>
      </div>
      <div id="qrCodePlaceholder" class="text-muted">
        –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ QR-–∫–æ–¥" –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–¥—É –∑ –≤–∞—à–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é.
      </div>
    </div>
  </div>

  <!-- –§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é -->
  {% if user.profile_picture %}
  <img
    src="{{ url_for('static', filename='uploads/profile_pictures/' ~ user.profile_picture) }}"
    alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é"
    class="rounded-circle mb-3"
    style="width: 150px; height: 150px; object-fit: cover"
    onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
  />
  {% endif %}
  
  {% if not user.profile_picture %}
  <div class="mb-3 p-3 bg-light rounded">
    <p class="mb-0">–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.</p>
  </div>
  {% endif %}

  <!-- –§–æ—Ä–º–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é -->
  <form method="POST" enctype="multipart/form-data" class="mb-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="mb-3">
      <label for="full_name" class="form-label">–ü–æ–≤–Ω–µ —ñ–º'—è:</label>
      <input
        type="text"
        name="full_name"
        id="full_name"
        class="form-control"
        value="{{ user.full_name or '' }}"

      />
    </div>

    <div class="mb-3">
      <label for="phone_number" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
      <input
        type="text"
        name="phone_number"
        id="phone_number"
        class="form-control"
        value="{{ user.phone_number or '' }}"
      />
    </div>
    
    <div class="mb-3">
      <label for="date_birth" class="form-label">–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è:</label>
      <input
        type="date"
        name="date_birth"
        id="date_birth"
        class="form-control"
        value="{{ formatted_date }}"
      />
    </div>

    <div class="mb-3">
      <label for="about_me" class="form-label">–ü—Ä–æ —Å–µ–±–µ:</label>
      <textarea name="about_me" id="about_me" class="form-control" rows="3">{{ user.about_me or '' }}</textarea>
    </div>

    <div class="mb-3">
      <label for="address" class="form-label">–ê–¥—Ä–µ—Å–∞:</label>
      <input
        type="text"
        name="address"
        id="address"
        class="form-control"
        value="{{ user.address or '' }}"
      />
    </div>
    
    <div class="mb-3">
      <label for="profile_picture" class="form-label">–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é:</label>
      <input
        type="file"
        name="profile_picture"
        id="profile_picture"
        class="form-control"
        accept="image/*"
      />
      <div class="form-text">–ü—Ä–∏–π–º–∞—é—Ç—å—Å—è JPG, PNG, GIF (–º–∞–∫—Å. 5MB)</div>
    </div>

    <div class="mb-3">
      <label for="documents" class="form-label">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏:</label>
      <input
        type="file"
        name="documents"
        id="documents"
        multiple
        class="form-control"
      />
      <div class="form-text">–ú–æ–∂–Ω–∞ –≤–∏–±—Ä–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ —Ñ–∞–π–ª—ñ–≤ (PDF, JPG, PNG)</div>
    </div>

    <button type="submit" class="btn btn-primary">–û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
    <a href="{{ url_for('client.dashboard') }}" class="btn btn-secondary">–ù–∞–∑–∞–¥ –¥–æ –ø–∞–Ω–µ–ª—ñ</a>
  </form>

  <hr />

  <!-- –ü–µ—Ä–µ–ª—ñ–∫ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ -->
  <h4>–í–∞—à—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏:</h4>
  {% if user_documents %}
  <ul class="list-group" id="documents-list">
    {% for doc in user_documents %}
    <li
      class="list-group-item d-flex justify-content-between align-items-center"
      data-filename="{{ doc }}"
    >
      <a
        href="{{ url_for('static', filename='uploads/documents/' ~ doc) }}"
        target="_blank"
        class="text-decoration-none"
      >
        üìÑ {{ doc }}
      </a>
      <button type="button" class="btn btn-sm btn-danger delete-doc-btn">
        –í–∏–¥–∞–ª–∏—Ç–∏
      </button>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <div class="alert alert-info">
    –î–æ–∫—É–º–µ–Ω—Ç–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.
  </div>
  {% endif %}
</div>

<!-- –î–æ–¥–∞—î–º–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó QR-–∫–æ–¥—ñ–≤ -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const docsList = document.getElementById("documents-list");
    if (!docsList) return;

    docsList.addEventListener("click", async (event) => {
      if (event.target.classList.contains("delete-doc-btn")) {
        const li = event.target.closest("li");
        const filename = li.getAttribute("data-filename");

        if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç "${filename}"?`)) return;

        try {
          const response = await fetch('{{ url_for("client.delete_document") }}', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token() }}"
            },
            body: JSON.stringify({ doc_name: filename })
          });

          const result = await response.json();

          if (result.success) {
            li.remove();
            // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É, —è–∫—â–æ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –±—ñ–ª—å—à–µ –Ω–µ –∑–∞–ª–∏—à–∏–ª–æ—Å—å
            if (docsList.children.length === 0) {
              location.reload();
            }
          } else {
            alert("–ü–æ–º–∏–ª–∫–∞: " + result.message);
          }
        } catch (error) {
          alert("–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + error.message);
        }
      }
    });

    // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ
    const profilePicInput = document.getElementById('profile_picture');
    if (profilePicInput) {
      profilePicInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–º—ñ—Ä—É —Ñ–∞–π–ª—É (–º–∞–∫—Å. 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä - 5MB.');
            this.value = '';
          }
          
          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∏–ø—É —Ñ–∞–π–ª—É
          const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
          if (!validTypes.includes(file.type)) {
            alert('–î–æ–∑–≤–æ–ª–µ–Ω—ñ –ª–∏—à–µ JPG, PNG —Ç–∞ GIF —Ñ–∞–π–ª–∏.');
            this.value = '';
          }
        }
      });
    }

    // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó QR-–∫–æ–¥—É
    const generateQRBtn = document.getElementById('generateQRBtn');
    if (generateQRBtn) {
      generateQRBtn.addEventListener('click', async function() {
        try {
          // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
          generateQRBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è...';
          generateQRBtn.disabled = true;
          
          // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞
          const response = await fetch('{{ url_for("client.generate_qr_data") }}');
          const qrData = await response.json();
          
          // –ì–µ–Ω–µ—Ä—É—î–º–æ QR-–∫–æ–¥
          const qrContainer = document.getElementById('qrcode');
          qrContainer.innerHTML = '';
          
          // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ toDataURL –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          QRCode.toDataURL(qrData.profile_url, {  // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ URL, –∞ –Ω–µ JSON
            width: 200,
            margin: 1,
            color: {
              dark: '#000000',
              light: '#ffffff'
            }
          }, function(error, url) {
            if (error) {
              console.error(error);
              alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó QR-–∫–æ–¥—É');
              generateQRBtn.innerHTML = '–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ QR-–∫–æ–¥';
              generateQRBtn.disabled = false;
              return;
            }
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ img –µ–ª–µ–º–µ–Ω—Ç –∑ QR-–∫–æ–¥–æ–º
            const img = document.createElement('img');
            img.src = url;
            img.alt = "QR –∫–æ–¥ –ø—Ä–æ—Ñ—ñ–ª—é";
            qrContainer.appendChild(img);
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑ QR-–∫–æ–¥–æ–º
            document.getElementById('qrCodeContainer').classList.remove('d-none');
            document.getElementById('qrCodePlaceholder').classList.add('d-none');
            
            // –î–æ–¥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            const downloadLink = document.getElementById('downloadQR');
            downloadLink.href = url;
            downloadLink.download = 'medical-profile-qr.png';
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É
            generateQRBtn.innerHTML = '–û–Ω–æ–≤–∏—Ç–∏ QR-–∫–æ–¥';
            generateQRBtn.disabled = false;
          });
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó QR-–∫–æ–¥—É');
          generateQRBtn.innerHTML = '–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ QR-–∫–æ–¥';
          generateQRBtn.disabled = false;
        }
      });
    }
  });
</script>
{% endblock %}