{% extends "base.html" %} {% block content %}
<div class="nurse-appointments">
  <h2>My appointments</h2>
  <a href="{{ url_for('nurse.dashboard') }}" class="btn btn-info mb-3 rounded-3">
    ← Back to dashboard
  </a>

  <div id="calendar"></div>
</div>

<div class="modal fade" id="appointmentDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Appointment details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>Client:</strong> <span id="detailClientName"></span>
        </div>
        <div class="mb-3">
          <strong>Service:</strong> <span id="detailServiceName"></span>
        </div>
        <div class="mb-3">
          <strong>Date and time:</strong> <span id="detailDateTime"></span>
        </div>
        <div class="mb-3">
          <strong>Status:</strong> <span id="detailStatus"></span>
        </div>
        <div class="mb-3">
          <strong>Notes:</strong>
          <div id="detailNotes" class="p-2 border rounded bg-light"></div>
        </div>
      </div>
      <div class="modal-footer" id="appointmentActions">
        </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/uk.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const calendarEl = document.getElementById("calendar");
    const isMobile = window.innerWidth < 768;
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: isMobile ? "listWeek" : "dayGridMonth",
      height: isMobile ? '75vh' : 'auto',
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: isMobile ? "dayGridMonth,listWeek" : "dayGridMonth,timeGridWeek,timeGridDay",
      },
      locale: "en",
      events: "/nurse/get_appointments",
      dayMaxEvents: true,

      // Додаємо класи для кольорів подій залежно від статусу
      eventClassNames: function(arg) {
        return [arg.event.extendedProps.status];
      },

      eventClick: function (info) {
        const props = info.event.extendedProps;

        document.getElementById("detailClientName").textContent = props.client_name || 'Unknown';
        document.getElementById("detailServiceName").textContent = props.service_name || 'Service';
        document.getElementById("detailDateTime").textContent = info.event.start.toLocaleString("uk-UA");
        document.getElementById("detailStatus").textContent = getStatusText(props.status);
        document.getElementById("detailNotes").textContent = props.notes || "No comments";

        const actionsContainer = document.getElementById("appointmentActions");
        actionsContainer.innerHTML = "";

        // Логіка кнопок для медсестри
        if (props.status === "scheduled") {
          actionsContainer.innerHTML = `
            <button class="btn btn-success" onclick="updateStatus(${info.event.id}, 'confirmed')">Confirm</button>
            <button class="btn btn-danger" onclick="updateStatus(${info.event.id}, 'cancelled')">Cancel</button>
          `;
        } else if (props.status === "confirmed" || props.status === "confirmed_paid") {
          actionsContainer.innerHTML = `
            <button class="btn btn-primary" onclick="updateStatus(${info.event.id}, 'completed')">Mark as Done</button>
          `;
        }
        
        actionsContainer.innerHTML += `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>`;

        const modal = new bootstrap.Modal(document.getElementById("appointmentDetailsModal"));
        modal.show();
      },
    });

    calendar.render();

    // Функція оновлення статусу (робимо її глобальною через window)
    window.updateStatus = function (appointmentId, status) {
      if (!confirm(`Change status to ${status}?`)) return;

      fetch("/nurse/update_appointment_status", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({
          appointment_id: appointmentId,
          status: status,
        }),
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          calendar.refetchEvents(); // Оновлюємо календар без перезавантаження сторінки
          const modalElem = document.getElementById("appointmentDetailsModal");
          const modalInstance = bootstrap.Modal.getInstance(modalElem);
          if (modalInstance) modalInstance.hide();
        } else {
          alert("Error: " + data.message);
        }
      })
      .catch(err => console.error("Fetch error:", err));
    };

    function getStatusText(status) {
      const statuses = {
        scheduled: "Pending",
        confirmed: "Confirmed",
        completed: "Completed",
        cancelled: "Cancelled",
        confirmed_paid: "Paid & Confirmed",
      };
      return statuses[status] || status;
    }
  });
</script>

<style>
  #calendar {
    max-width: 100%;
    margin: 0 auto;
    background-color: white;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  /* Стилі для різних статусів подій */
  .fc-event.scheduled { background-color: #ffc107 !important; border-color: #ffc107 !important; color: #000 !important; }
  .fc-event.confirmed { background-color: #0d6efd !important; border-color: #0d6efd !important; }
  .fc-event.confirmed_paid { background-color: #198754 !important; border-color: #198754 !important; }
  .fc-event.completed { background-color: #6c757d !important; border-color: #6c757d !important; }
  .fc-event.cancelled { background-color: #dc3545 !important; border-color: #dc3545 !important; text-decoration: line-through; }

  @media (max-width: 768px) {
    .fc-toolbar-title { font-size: 1rem !important; }
    .fc-header-toolbar { flex-wrap: wrap; gap: 10px; justify-content: center; }
  }
</style>
{% endblock %}