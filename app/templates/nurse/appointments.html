{% extends "base.html" %} {% block content %}
<div class="nurse-appointments">
  <h2>My appointments</h2>
  <a href="{{ url_for('nurse.dashboard') }}" class="btn btn-info">
    <i class="fas fa-user"></i> Exit
  </a>
  <!-- Calendar -->
  <div id="calendar"></div>
</div>

<!-- Modal window for appointment details -->
<div
  class="modal fade"
  id="appointmentDetailsModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Appointments details</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>Client:</strong> <span id="detailClientName"></span>
        </div>
        <div class="mb-3">
          <strong>Service:</strong> <span id="detailServiceName"></span>
        </div>
        <div class="mb-3">
          <strong>Date and time:</strong> <span id="detailDateTime"></span>
        </div>
        <div class="mb-3">
          <strong>Status:</strong> <span id="detailStatus"></span>
        </div>
        <div class="mb-3">
          <strong>Notes:</strong>
          <div id="detailNotes"></div>
        </div>
      </div>
      <div class="modal-footer" id="appointmentActions">
        <!-- Action buttons will appear here -->
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/uk.min.js"></script>

<script>
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  document.addEventListener("DOMContentLoaded", function () {
    // Initialize calendar
    const calendarEl = document.getElementById("calendar");
    const isMobile = window.innerWidth < 768;

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: isMobile ? "listWeek" : "dayGridMonth",
      
      height: isMobile ? '75vh' : 'auto',
      
      headerToolbar: {
        left: "prev,next",
        center: "title",
        right: isMobile ? "dayGridMonth,listWeek" : "dayGridMonth,timeGridWeek,timeGridDay",
      },
      locale: "en",
      
      events: "/nurse/get_appointments",

      dayMaxEvents: true,

      eventClick: function (info) {
        const props = info.event.extendedProps;

        document.getElementById("detailClientName").textContent = props.client_name || 'Unknown';
        document.getElementById("detailServiceName").textContent = props.service_name || 'Service';
        document.getElementById("detailDateTime").textContent = info.event.start.toLocaleString("uk-UA");
        document.getElementById("detailStatus").textContent = getStatusText(props.status);
        document.getElementById("detailNotes").textContent = props.notes || "No comments";


        const actionsContainer = document.getElementById("appointmentActions");
        actionsContainer.innerHTML = "";

        if (props.status === "scheduled") {
          // Buttons for scheduled appointment
          actionsContainer.innerHTML = `
            <button class="btn btn-success" onclick="updateStatus(${info.event.id}, 'confirmed')">Confirm</button>
            <button class="btn btn-danger" onclick="updateStatus(${info.event.id}, 'cancelled')">Cancel</button>
          `;
        } else if (props.status === "confirmed") {
          // Button for confirmed appointment
          actionsContainer.innerHTML = `
            <button class="btn btn-primary" onclick="updateStatus(${info.event.id}, 'completed')">Done</button>
          `;
        }

        const modal = new bootstrap.Modal(document.getElementById("appointmentDetailsModal"));
        modal.show();
      },
    });
    calendar.render();

    // Function for updating status
    window.updateStatus = function (appointmentId, status) {
      fetch("/nurse/update_appointment_status", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({
          appointment_id: appointmentId,
          status: status,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            calendar.refetchEvents(); 
            bootstrap.Modal.getInstance(document.getElementById("appointmentDetailsModal")).hide();
          } else {
            alert("Error: " + data.message);
          }
        })
        .catch(err => console.error(err));
    };

    function getStatusText(status) {
      const statuses = {
        scheduled: "scheduled",
        confirmed: "confirmed",
        completed: "completed",
        cancelled: "cancel",
      };
      return statuses[status] || status;
    }
  });
</script>

<style>
  #calendar {
    max-width: 100%;
    margin: 0 auto;
    background-color: white;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }

  /* Адаптивність для мобільних */
  @media (max-width: 768px) {
    .fc-toolbar-title {
        font-size: 1.1rem !important;
    }
    .fc-header-toolbar {
        flex-direction: column;
        gap: 5px;
    }
    .fc-button {
        padding: 0.2rem 0.5rem;
        font-size: 0.9rem;
    }
  }
</style>
{% endblock %}