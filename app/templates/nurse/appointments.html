{% extends "base.html" %} {% block content %}
<div class="nurse-appointments">
  <h2>My appointments</h2>
  <a href="{{ url_for('nurse.dashboard') }}" class="btn btn-info mb-3 rounded-3">
    ‚Üê Back to dashboard
  </a>

  <div id="calendar"></div>
</div>

<div class="modal fade" id="appointmentDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Appointment details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>Client:</strong> <span id="detailClientName"></span>
        </div>
        <div class="mb-3">
          <strong>Service:</strong> <span id="detailServiceName"></span>
        </div>
        <div class="mb-3">
          <strong>Date and time:</strong> <span id="detailDateTime"></span>
        </div>
        <div class="mb-3">
          <strong>Status:</strong> <span id="detailStatus"></span>
        </div>
        <div class="mb-3">
          <strong>Notes:</strong>
          <div id="detailNotes" class="p-2 border rounded bg-light"></div>
        </div>
      </div>
      <div class="modal-footer" id="appointmentActions">
        </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/uk.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const calendarEl = document.getElementById("calendar");
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    function getResponsiveSettings() {
      const isMobile = window.innerWidth < 768;
      return {
        view: isMobile ? "listWeek" : "dayGridMonth",
        height: isMobile ? "75vh" : "auto",
        header: {
          left: "prev,next today",
          center: "title",
          right: isMobile ? "listWeek,dayGridMonth" : "dayGridMonth,timeGridWeek,timeGridDay",
        }
      };
    }

    const initialSettings = getResponsiveSettings();

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: initialSettings.view,
      height: initialSettings.height,
      headerToolbar: initialSettings.header,
      locale: "en", 
      events: "/nurse/get_appointments",
      dayMaxEvents: true,
      handleWindowResize: true, 


      windowResize: function(view) {
        const newSettings = getResponsiveSettings();

        calendar.changeView(newSettings.view);

        calendar.setOption('headerToolbar', newSettings.header);
        
        calendar.setOption('height', newSettings.height);
      },

      eventClassNames: function(arg) {
        return [arg.event.extendedProps.status];
      },

      eventClick: function (info) {
        const props = info.event.extendedProps;

        document.getElementById("detailClientName").textContent = props.client_name || 'Unknown';
        document.getElementById("detailServiceName").textContent = props.service_name || 'Service';
        document.getElementById("detailDateTime").textContent = info.event.start.toLocaleString("uk-UA");
        document.getElementById("detailStatus").textContent = getStatusText(props.status);
        document.getElementById("detailNotes").textContent = props.notes || "No comments";

        const actionsContainer = document.getElementById("appointmentActions");
        actionsContainer.innerHTML = "";

        if (props.status === "scheduled") {
          actionsContainer.innerHTML = `
            <button class="btn btn-success" onclick="updateStatus(${info.event.id}, 'confirmed')">Confirm</button>
            <button class="btn btn-danger" onclick="updateStatus(${info.event.id}, 'cancelled')">Cancel</button>
          `;
        } else if (props.status === "confirmed" || props.status === "confirmed_paid") {
          actionsContainer.innerHTML = `
            <button class="btn btn-primary" onclick="updateStatus(${info.event.id}, 'completed')">Mark as Done</button>
          `;
        }
        
        actionsContainer.innerHTML += `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>`;
        const modal = new bootstrap.Modal(document.getElementById("appointmentDetailsModal"));
        modal.show();
      },
    });

    calendar.render();

    window.updateStatus = function (appointmentId, status) {
      if (!confirm(`Change status to ${status}?`)) return;

      fetch("/nurse/update_appointment_status", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({
          appointment_id: appointmentId,
          status: status,
        }),
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          calendar.refetchEvents();
          const modalElem = document.getElementById("appointmentDetailsModal");
          const modalInstance = bootstrap.Modal.getInstance(modalElem);
          if (modalInstance) modalInstance.hide();
        } else {
          alert("Error: " + data.message);
        }
      })
      .catch(err => console.error("Fetch error:", err));
    };

    function getStatusText(status) {
      const statuses = {
        scheduled: "Pending",
        confirmed: "Confirmed",
        completed: "Completed",
        cancelled: "Cancelled",
        confirmed_paid: "Paid & Confirmed",
      };
      return statuses[status] || status;
    }
  });
</script>


{% endblock %}