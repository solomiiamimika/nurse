{% extends "base.html" %} 
{% block content %}

<div class="ambient-background"></div>

<div class="main-wrapper" style="padding-top: 40px; padding-bottom: 60px;">
  
  <div class="custom-container">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
          <h2 style="margin-bottom: 5px; font-weight: 700; color: #1f2937;">Service Management</h2>
          <span class="text-muted">Configure the services you offer to clients</span>
      </div>
      <a href="{{ url_for('nurse.dashboard') }}" class="btn-tool">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>

    <div class="content-card mb-4">
      <div class="d-flex align-items-center mb-3 border-bottom pb-2">
         <div class="icon-square me-2 bg-primary bg-opacity-10 text-primary">
            <i class="fas fa-list"></i>
         </div>
         <h5 class="fw-bold mb-0">Standard Platform Services</h5>
      </div>
      
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 20%">Name</th>
              <th style="width: 30%">Description</th>
              <th>Base Price</th>
              <th>Duration</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for service in standard_services %}
            <tr>
              <td class="fw-bold text-dark">{{ service.name }}</td>
              <td class="text-muted small">{{ service.description }}</td>
              <td>{{ service.base_price }} €</td>
              <td>{{ service.base_duration }} min</td>
              <td class="text-end">
                {% set nurse_service = nurse_services|selectattr("service_id", "equalto", service.id)|first %} 
                {% if nurse_service %}
                <div class="btn-group">
                    <button
                        class="btn btn-sm btn-outline-primary edit-service-btn"
                        data-service-id="{{ service.id }}"
                        data-price="{{ nurse_service.price }}"
                        data-duration="{{ nurse_service.duration }}"
                        data-description="{{ nurse_service.description }}"
                        data-available="{{ nurse_service.is_available }}"
                        title="Edit details"
                    >
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button
                        class="btn btn-sm btn-outline-danger remove-service-btn"
                        data-service-id="{{ service.id }}"
                        title="Remove from my list"
                    >
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                {% else %}
                <button
                    class="btn btn-sm btn-success add-service-btn fw-bold"
                    data-service-id="{{ service.id }}"
                    data-name="{{ service.name }}"
                >
                    <i class="fas fa-plus"></i> Add to My List
                </button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="content-card">
      <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
         <div class="d-flex align-items-center">
             <div class="icon-square me-2 bg-success bg-opacity-10 text-success">
                <i class="fas fa-magic"></i>
             </div>
             <h5 class="fw-bold mb-0">My Custom Services</h5>
         </div>
         <button class="btn btn-primary btn-sm fw-bold" id="addCustomServiceBtn">
           <i class="fas fa-plus"></i> Create New Service
         </button>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 20%">Name</th>
              <th style="width: 30%">Description</th>
              <th>Price</th>
              <th>Duration</th>
              <th>Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for service in nurse_services if not service.service_id %}
            <tr>
              <td class="fw-bold text-dark">{{ service.name }}</td>
              <td class="text-muted small">{{ service.description }}</td>
              <td>{{ service.price }} €</td>
              <td>{{ service.duration }} min</td>
              <td>
                {% if service.is_available %}
                  <span class="badge bg-success bg-opacity-10 text-success border border-success">Available</span>
                {% else %}
                  <span class="badge bg-secondary bg-opacity-10 text-secondary border">Hidden</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="btn-group">
                    <button
                    class="btn btn-sm btn-outline-primary edit-service-btn"
                    data-service-id="{{ service.id }}"
                    data-price="{{ service.price }}"
                    data-duration="{{ service.duration }}"
                    data-description="{{ service.description }}"
                    data-available="{{ service.is_available }}"
                    data-name="{{ service.name }}"
                    data-custom="true"
                    >
                    <i class="fas fa-edit"></i>
                    </button>
                    <button
                    class="btn btn-sm btn-outline-danger remove-service-btn"
                    data-service-id="{{ service.id }}"
                    data-custom="true"
                    >
                    <i class="fas fa-trash"></i>
                    </button>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                    You haven't created any custom services yet.
                </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="serviceModalTitle">Add Service</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="serviceForm" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="service_id" id="formServiceId" />
        <input type="hidden" name="action" id="formAction" />
        <input type="hidden" name="is_custom" id="formIsCustom" value="false" />

        <div class="modal-body">
          <div class="mb-3" id="customNameField" style="display:none;">
            <label for="name" class="form-label fw-bold small text-muted">SERVICE NAME</label>
            <input type="text" class="form-control" id="name" name="name" required />
          </div>
          
          <div class="row">
              <div class="col-6 mb-3">
                <label for="price" class="form-label fw-bold small text-muted">PRICE (EUR)</label>
                <input type="number" step="0.01" class="form-control" id="price" name="price" required />
              </div>
              <div class="col-6 mb-3">
                <label for="duration" class="form-label fw-bold small text-muted">DURATION (MIN)</label>
                <input type="number" class="form-control" id="duration" name="duration" required />
              </div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label fw-bold small text-muted">DESCRIPTION</label>
            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Optional details..."></textarea>
          </div>
          
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="is_available" name="is_available" checked>
            <label class="form-check-label" for="is_available">Available for booking immediately</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary fw-bold px-4">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold text-danger">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to remove this service from your list?</p>
        <p class="small text-muted mb-0">This action cannot be undone instantly.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger fw-bold" id="confirmDeleteBtn">Delete Service</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<style>
    .custom-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }
    .content-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .icon-square {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .btn-tool {
        background: white;
        border: 1px solid #e5e7eb;
        color: #4b5563;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }
    .btn-tool:hover {
        background: #f9fafb;
        color: #111827;
        border-color: #d1d5db;
    }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Handle Add Custom Service Button
    document.getElementById('addCustomServiceBtn').addEventListener('click', function() {
      document.getElementById('formAction').value = 'add_custom';
      document.getElementById('formIsCustom').value = 'true';
      document.getElementById('serviceModalTitle').textContent = 'Create New Custom Service';
      document.getElementById('customNameField').style.display = 'block';
      
      // Reset form
      document.getElementById('formServiceId').value = '';
      document.getElementById('name').value = '';
      document.getElementById('price').value = '';
      document.getElementById('duration').value = '';
      document.getElementById('description').value = '';
      document.getElementById('is_available').checked = true;
      
      const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
      modal.show();
    });

    // Handle Add Standard Service Button
    document.querySelectorAll('.add-service-btn').forEach((btn) => {
      btn.addEventListener('click', function() {
        const serviceId = this.getAttribute('data-service-id');
        const serviceName = this.getAttribute('data-name');
        
        document.getElementById('formAction').value = 'add';
        document.getElementById('formIsCustom').value = 'false';
        document.getElementById('formServiceId').value = serviceId;
        document.getElementById('serviceModalTitle').textContent = `Add Service: ${serviceName}`;
        document.getElementById('customNameField').style.display = 'none';
        
        // Reset form
        document.getElementById('price').value = '';
        document.getElementById('duration').value = '';
        document.getElementById('description').value = '';
        document.getElementById('is_available').checked = true;
        
        const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
        modal.show();
      });
    });

    // Handle Edit Service Button
    document.querySelectorAll('.edit-service-btn').forEach((btn) => {
      btn.addEventListener('click', function() {
        const isCustom = this.hasAttribute('data-custom');
        const serviceId = this.getAttribute('data-service-id');
        const price = this.getAttribute('data-price');
        const duration = this.getAttribute('data-duration');
        const description = this.getAttribute('data-description');
        const available = this.getAttribute('data-available') === 'True';
        
        document.getElementById('formAction').value = 'update';
        document.getElementById('formIsCustom').value = isCustom ? 'true' : 'false';
        document.getElementById('formServiceId').value = serviceId;
        document.getElementById('serviceModalTitle').textContent = 'Edit Service Details';
        
        if (isCustom) {
          const name = this.getAttribute('data-name');
          document.getElementById('customNameField').style.display = 'block';
          document.getElementById('name').value = name;
        } else {
          document.getElementById('customNameField').style.display = 'none';
        }
        
        document.getElementById('price').value = price;
        document.getElementById('duration').value = duration;
        document.getElementById('description').value = description;
        document.getElementById('is_available').checked = available;
        
        const modal = new bootstrap.Modal(document.getElementById('serviceModal'));
        modal.show();
      });
    });

    // Handle Delete Service Button
    let serviceToDelete = null;
    let isCustomToDelete = false;
    
    document.querySelectorAll('.remove-service-btn').forEach((btn) => {
      btn.addEventListener('click', function() {
        serviceToDelete = this.getAttribute('data-service-id');
        isCustomToDelete = this.hasAttribute('data-custom');
        
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
      });
    });
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
      if (serviceToDelete) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '';
        
        // Add CSRF Token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = "{{ csrf_token() }}";
        form.appendChild(csrfInput);

        const serviceIdInput = document.createElement('input');
        serviceIdInput.type = 'hidden';
        serviceIdInput.name = 'service_id';
        serviceIdInput.value = serviceToDelete;
        form.appendChild(serviceIdInput);
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = isCustomToDelete ? 'remove_custom' : 'remove';
        form.appendChild(actionInput);
        
        document.body.appendChild(form);
        form.submit();
      }
    });
  });
</script>
{% endblock %}