{% extends "base.html" %} 
{% block content %}

<div class="ambient-background"></div>

<div class="main-wrapper" style="padding-top: 40px; padding-bottom: 60px;">

  <div class="custom-container" style="max-width: 800px; margin: 0 auto;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
          <h2 style="margin-bottom: 5px; font-weight: 700; color: #1f2937;">Service Provider Profile</h2>
          <span class="text-muted">Manage your personal information and documents</span>
      </div>
      <a href="{{ url_for('nurse.dashboard') }}" class="btn-tool">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %} 
        {% if messages %} 
        {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show shadow-sm" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %} 
        {% endif %} 
    {% endwith %}

    <div class="content-card">
      <form method="POST" enctype="multipart/form-data" class="client-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <div class="text-center mb-5">
            <div class="profile-img-container mb-3">
                {% if profile_photo %}
                <img src="{{ profile_photo }}" class="client-avatar shadow-sm" alt="Profile Photo" />
                {% else %}
                <div class="client-no-photo shadow-sm">
                    <i class="fas fa-user-nurse fa-3x text-muted"></i>
                </div>
                {% endif %}
                
                <label for="profile_picture" class="edit-photo-btn" title="Change photo">
                    <i class="fas fa-camera"></i>
                </label>
            </div>

            <input type="file" name="profile_picture" id="profile_picture" class="d-none" accept="image/*" />
            <div class="text-muted small">Allowed: JPG, PNG, GIF (Max 5MB)</div>
        </div>












        

        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label fw-bold small text-muted">FULL NAME</label>
                <input type="text" name="full_name" class="form-control" value="{{ user.full_name or '' }}" />
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold small text-muted">PHONE NUMBER</label>
                <input type="text" name="phone_number" class="form-control" value="{{ user.phone_number or '' }}" />
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold small text-muted">BIRTH DATE</label>
                <input type="date" name="date_birth" class="form-control" value="{{ formatted_date }}" />
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold small text-muted">ADDRESS</label>
                <input type="text" name="address" class="form-control" value="{{ user.address or '' }}" />
            </div>

            <div class="col-12">
                <label class="form-label fw-bold small text-muted">ABOUT ME</label>
                <textarea name="about_me" class="form-control" rows="3">{{ user.about_me or '' }}</textarea>
            </div>

            <div class="col-12 mt-4">
                <label class="form-label fw-bold small text-muted">UPLOAD DOCUMENTS</label>
                <div class="input-group">
                    <input type="file" name="documents" id="documents" multiple class="form-control" />
                    <span class="input-group-text text-muted"><i class="fas fa-file-upload"></i></span>
                </div>
                <div class="form-text">You can select multiple files (PDF, JPG, PNG)</div>
            </div>
        </div>
        
        <div class="d-flex justify-content-end mt-4 pt-3 border-top">
            <button type="submit" class="btn btn-primary fw-bold px-4">Update Profile</button>
        </div>
      </form>

      <div class="mt-5">
        <h5 class="mb-3 fw-bold text-dark">Your Documents</h5>
        
        {% if documents_urls %} 
        <div class="documents-grid">
            {% for filename, url in documents_urls.items() %}
            <div class="client-doc-item" data-filename="{{ filename }}">
                <div class="d-flex align-items-center overflow-hidden">
                    <div class="doc-icon me-3">
                        <i class="fas fa-file-medical text-primary"></i>
                    </div>
                    <a href="{{ url }}" target="_blank" class="text-truncate text-dark text-decoration-none fw-bold" style="max-width: 200px;">
                        {{ filename }}
                    </a>
                </div>
                <button class="btn btn-sm btn-light text-danger delete-doc-btn border" title="Delete">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
            {% endfor %} 
        </div>
        {% else %}
        <div class="p-4 text-center bg-light rounded border border-dashed">
            <i class="fas fa-folder-open fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">No documents uploaded yet.</p>
        </div>
        {% endif %}
      </div>

    </div>
  </div>
</div>


        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Payout Settings</h5>
                
                {% if current_user.stripe_account_id %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 
                        Payout Account Connected
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Connect your bank account to receive payments.
                    </div>
                    
                    <form action="{{ url_for('nurse.connect_stripe') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <div class="mb-3">
                            <label class="form-label">Select your country:</label>
                            <select name="country" class="form-select" required>
                                <option value="UA">Ukraine (UA)</option>
                                <option value="US">United States (US)</option>
                                <option value="PL">Poland (PL)</option>
                                <option value="DE">Germany (DE)</option>
                                <option value="GB">United Kingdom (GB)</option>
                                <option value="FR">France (FR)</option>
                                <option value="ES">Spain (ES)</option>
                                <option value="IT">Italy (IT)</option>
                                </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fab fa-stripe-s"></i> Connect with Stripe
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>

{% endblock %}

{% block scripts %}
<style>
    /* Reuse styles from client profile for consistency */
    .custom-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }
    .content-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    
    /* Button Tool */
    .btn-tool {
        background: white;
        border: 1px solid #e5e7eb;
        color: #4b5563;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }
    .btn-tool:hover {
        background: #f9fafb;
        color: #111827;
        border-color: #d1d5db;
    }

    /* Avatar Styles */
    .profile-img-container {
        position: relative;
        width: 130px;
        height: 130px;
        margin: 0 auto;
    }
    .client-avatar, .client-no-photo {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid white;
    }
    .client-no-photo {
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .edit-photo-btn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: #3b82f6;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 2px solid white;
        transition: transform 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .edit-photo-btn:hover {
        transform: scale(1.1);
        background: #2563eb;
    }

    /* Documents Grid */
    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
    }
    .client-doc-item {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }
    .client-doc-item:hover {
        background: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border-color: #cbd5e1;
        transform: translateY(-1px);
    }
    .doc-icon {
        width: 36px;
        height: 36px;
        background: #e0f2fe;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    
    // Document Deletion Logic
    document.addEventListener("click", async (event) => {
      const deleteBtn = event.target.closest(".delete-doc-btn");
      
      if (deleteBtn) {
        event.preventDefault();
        
        const docItem = deleteBtn.closest(".client-doc-item");
        const filename = docItem.getAttribute("data-filename");

        if (!confirm(`Delete document "${filename}"?`)) return;

        try {
          const response = await fetch('{{ url_for("nurse.delete_document") }}', {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token() }}"
            },
            body: JSON.stringify({ doc_name: filename }),
          });

          const result = await response.json();

          if (result.success) {
            docItem.style.transition = "all 0.3s";
            docItem.style.opacity = "0";
            docItem.style.transform = "scale(0.9)";
            setTimeout(() => {
                docItem.remove();
                // Reload if no docs left to show the "empty" state (optional)
                const remainingDocs = document.querySelectorAll('.client-doc-item');
                if (remainingDocs.length === 0) {
                    location.reload();
                }
            }, 300);
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          console.error(error);
          alert("Server error.");
        }
      }
    });

    // File Input Validation
    const profilePicInput = document.getElementById("profile_picture");
    if (profilePicInput) {
      profilePicInput.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            alert("The file is too large. The maximum size is 5MB.");
            this.value = "";
          } else {
            const validTypes = ["image/jpeg", "image/png", "image/gif"];
            if (!validTypes.includes(file.type)) {
                alert("Only JPG, PNG, and GIF files are allowed.");
                this.value = "";
            } else {
                // Optional: Instant preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.querySelector('.client-avatar');
                    const noPhoto = document.querySelector('.client-no-photo');
                    if(img) img.src = e.target.result;
                    if(noPhoto) {
                        noPhoto.innerHTML = `<img src="${e.target.result}" class="client-avatar" style="border:none;">`;
                        noPhoto.classList.remove('client-no-photo');
                    }
                }
                reader.readAsDataURL(file);
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}