{% extends "base.html" %} {% block content %}
<div class="container mt-4 profile-page">
    <a href="{{ url_for('nurse.dashboard') }}" class="btn btn-outline-secondary mb-3">
      ← Back to dashboard
    </a>
     <!--<a href="javascript:history.back()" class="btn btn-outline-secondary mb-3">
    ← Back
  </a>-->
  <h2 class="profile-title">Service provider profile</h2>

  <!-- Hamburger menu (can be for mobile)
  <div class="profile-menu-icon">
    <a href="{{ url_for('nurse.dashboard') }}">☰</a>
  </div>
-->
  <!-- Profile photo -->
  {% if user.photo %}
  <img
    src="{{ url_for('static', filename='uploads/profile_pictures/' ~ user.photo) }}"
    alt="Profile photo"
    class="rounded-circle mb-3 profile-avatar"
  />
  {% else %}
  <p class="profile-placeholder-text">Profile photo not uploaded.</p>
  {% endif %}

  <!-- Profile update form -->
  <form method="POST" enctype="multipart/form-data" class="mb-4 profile-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

    <div class="mb-3">
      <label for="full_name" class="form-label">Full name:</label>
      <input
        type="text"
        name="full_name"
        id="full_name"
        class="form-control"
        value="{{ user.full_name or '' }}"
      />
    </div>

    <div class="mb-3">
      <label for="phone_number" class="form-label">Phone number:</label>
      <input
        type="text"
        name="phone_number"
        id="phone_number"
        class="form-control"
        value="{{ user.phone_number or '' }}"
      />
    </div>

    <div class="mb-3">
      <label for="date_birth" class="form-label">Birth date:</label>
      <input
        type="date"
        name="date_birth"
        id="date_birth"
        class="form-control"
        value="{{ formatted_date }}"
      />
    </div>

    <div class="mb-3">
      <label for="about_me" class="form-label">About me:</label>
      <textarea name="about_me" id="about_me" class="form-control" rows="3">
{{ user.about_me or '' }}</textarea
      >
    </div>

    <div class="mb-3">
      <label for="address" class="form-label">Address:</label>
      <input
        type="text"
        name="address"
        id="address"
        class="form-control"
        value="{{ user.address or '' }}"
      />
    </div>

    <div class="mb-3">
      <label for="profile_picture" class="form-label">Profile photo:</label>
      <input
        type="file"
        name="profile_picture"
        id="profile_picture"
        class="form-control"
      />
    </div>

    <div class="mb-3">
      <label for="documents" class="form-label">Documents upload:</label>
      <input
        type="file"
        name="documents"
        id="documents"
        multiple
        class="form-control"
      />
    </div>
    <div class="d-flex justify-content-center mt-3">
      <button type="submit" class="btn btn-primary">Update profile</button>
    </div>

    <!-- <a href="{{ url_for('nurse.dashboard') }}" class="btn btn-secondary">
      Back to dashboard
    </a>-->
  </form>

  <hr />

  <!-- Document list -->
  <h4 class="mt-4 mb-3" style="color: var(--green-700)">Your documents</h4>
  {% if user_documents %}
  <ul class="list-group profile-doc-list" id="documents-list">
    {% for doc in user_documents %}
    <li
      class="list-group-item d-flex justify-content-between align-items-center"
      data-filename="{{ doc }}"
    >
      <a
        href="{{ url_for('static', filename='uploads/documents/' ~ doc) }}"
        target="_blank"
        >{{ doc }}</a
      >
      <button type="button" class="btn btn-sm btn-danger delete-doc-btn">
        Delete
      </button>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="profile-placeholder-text">Documents not uploaded.</p>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const docsList = document.getElementById("documents-list");
    if (!docsList) return;

    docsList.addEventListener("click", async (event) => {
      if (event.target.classList.contains("delete-doc-btn")) {
        const li = event.target.closest("li");
        const filename = li.getAttribute("data-filename");

        if (!confirm(`Delete document "${filename}"?`)) return;

        try {
          const formData = new FormData();
          formData.append("filename", filename);

          const response = await fetch(
            '{{ url_for("nurse.delete_document") }}',
            {
              method: "POST",
              body: formData,
            }
          );

          const result = await response.json();

          if (result.success) {
            li.remove();
            alert(result.message);
          } else {
            alert("Error: " + result.message);
          }
        } catch (error) {
          alert("Server error: " + error.message);
        }
      }
    });
  });
</script>
{% endblock %}
