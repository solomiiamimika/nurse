{% extends "base.html" %} 
{% block content %}

<div class="nurse-dashboard">
  <h2>Hi, {{ current_user.full_name if current_user.full_name else current_user.username}}!</h2>
  <h5 style="text-align: center">Service provider dashboard</h5>

  <div class="dashboard-options" style="margin-bottom: 20px">
    <a href="{{ url_for('nurse.profile') }}" class="btn btn-info"><i class="fas fa-user"></i> Profile</a>
    <a href="{{ url_for('nurse.appointments') }}" class="btn btn-info"><i class="fas fa-calendar"></i> Appointments</a>
    <a href="{{ url_for('nurse.manage_services') }}" class="btn btn-info"><i class="fas fa-concierge-bell"></i> My services</a>
    <button id="location-btn" class="btn btn-info"><i class="fas fa-map-marker-alt"></i> Update location</button>
    <button id="toggle-online-btn" class="btn {{ 'btn-success' if current_user.online else 'btn-secondary' }}">
      {{ 'Online' if current_user.online else 'Offline' }}
    </button>
    <form action="{{url_for('auth.logout')}}" method="post" style="display:inline">
       <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
       <button class="btn btn-info"><i class="fas fa-sign-out-alt"></i> Exit</button>
    </form>
    <div id="status-message" class="mt-2 small" style="width: 100%;"></div>
  </div>
</div> 

<div class="premium-box mt-4">
  <div class="row g-4"> 
    <div class="col-md-8">
      <h5 class="premium-title">Client and Service Request Map</h5>
      <div id="combinedMap" style="height: 500px; width: 100%"></div>
    </div>

    <div class="col-md-4">
      <h5 class="premium-title">Available requests</h5>
      <div style="height: 500px; overflow-y: auto; padding-right: 10px">
        <div id="requestsList">
          <div class="text-center mt-5"><div class="spinner-border text-secondary"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Request details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3"><strong>Client:</strong> <span id="detailPatientName"></span></div>
        <div class="mb-3"><strong>Service:</strong> <span id="detailServiceName"></span></div>
        <div class="mb-3"><strong>Time:</strong> <span id="detailDateTime"></span></div>
        <div class="mb-3"><strong>Notes:</strong> <div id="detailNotes"></div></div>
        <div class="mb-3"><strong>Suggested payment:</strong> <span id="detailPayment"></span> Eur</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="acceptRequestBtn">Accept request</button>
      </div>
    </div>
  </div>
</div>

{% endblock %} 

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

<script>
  let map;
  let userMarker;
  let requestMarkersLayer = L.layerGroup();
  let currentRequestId = null;
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

  function showStatus(message, isError = false) {
      const statusEl = document.getElementById('status-message');
      if(statusEl) { statusEl.textContent = message; statusEl.style.color = isError ? 'red' : 'green'; }
  }

  function initMap() {
      try {
          showStatus("Map initialization...");
          const nurseLat = {{ current_user.latitude if current_user.latitude is not none else 50.4501 }};
          const nurseLng = {{ current_user.longitude if current_user.longitude is not none else 30.5234}};

          map = L.map('combinedMap').setView([nurseLat, nurseLng], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

          requestMarkersLayer.addTo(map);

          if (nurseLat && nurseLng) {
              userMarker = L.marker([nurseLat, nurseLng], {
                  icon: L.divIcon({
                      className: 'nurse-marker',
                      html: '<div style="background-color: purple; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white;"></div>'
                  })
              }).addTo(map).bindPopup('Your location');
          }
          
          loadRequests();
          showStatus("");
      } catch (error) { showStatus("Map error: " + error.message, true); }
  }


  function loadRequests() {
      fetch('/nurse/nurse_get_requests')
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  displayRequests(data.requests);
                  updateRequestMarkers(data.requests);
              } else {
                  document.getElementById('requestsList').innerHTML = '<div class="alert alert-danger">Error loading requests</div>';
              }
          })
          .catch(error => console.error('Error:', error));
  }

  function displayRequests(requests) {
      const container = document.getElementById('requestsList');
      if (requests.length === 0) {
          container.innerHTML = '<div class="alert alert-info text-center">No requests available</div>';
          return;
      }
      let html = '';
      requests.forEach(request => {
          const time = new Date(request.appointment_start_time).toLocaleString('uk-UA');
          html += `
              <div class="card mb-3 nurse-item"> 
                  <div class="card-body">
                      <h6 class="card-title" style="color: var(--green-700); font-weight: bold;">${request.service_name}</h6>
                      <p class="card-text mb-1"><small><i class="fas fa-user"></i> ${request.patient_name || 'Unknown'}</small></p>
                      <p class="card-text mb-1"><small><i class="fas fa-clock"></i> ${time}</small></p>
                      <button class="btn-premium view-request-btn" onclick='showRequestDetails(${JSON.stringify(request)})'>Details</button>
                  </div>
              </div>`;
      });
      container.innerHTML = html;
  }

  function updateRequestMarkers(requests) {
      requestMarkersLayer.clearLayers();
      requests.forEach(request => {
          if (request.latitude && request.longitude) {
              const marker = L.marker([request.latitude, request.longitude], {
                  icon: L.divIcon({
                      className: 'request-marker',
                      html: '<div style="background-color: #d13a3a; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white; box-shadow: 0 0 5px red;"></div>'
                  })
              });
              
              marker.on('click', () => showRequestDetails(request));
              marker.addTo(requestMarkersLayer);
          }
      });
  }

  window.showRequestDetails = function(request) {
      currentRequestId = request.id;
      document.getElementById('detailPatientName').textContent = request.patient_name || 'Unknown';
      document.getElementById('detailServiceName').textContent = request.service_name || 'Service';
      document.getElementById('detailDateTime').textContent = new Date(request.appointment_start_time).toLocaleString('uk-UA');
      document.getElementById('detailNotes').textContent = request.notes || 'No notes';
      document.getElementById('detailPayment').textContent = request.payment || '0';
      new bootstrap.Modal(document.getElementById('requestDetailsModal')).show();
  }

  document.getElementById('acceptRequestBtn').addEventListener('click', function() {
      if (!currentRequestId) return;
      fetch(`/nurse/nurse_accept_request/${currentRequestId}`, {
          method: 'POST',
          headers: {'X-CSRFToken': csrfToken}
      })
      .then(r => r.json())
      .then(data => {
          if (data.success) {
              alert('Request successfully accepted');
              bootstrap.Modal.getInstance(document.getElementById('requestDetailsModal')).hide();
              loadRequests();
          } else { alert('Error: ' + data.message); }
      });
  });

  document.getElementById('location-btn').addEventListener('click', () => {
       navigator.geolocation.getCurrentPosition(pos => {
           fetch('{{ url_for("nurse.update_location") }}', {
               method: 'POST',
               headers: {'Content-Type': 'application/json','X-CSRFToken': csrfToken},
               body: JSON.stringify({latitude: pos.coords.latitude, longitude: pos.coords.longitude})
           }).then(r=>r.json()).then(res=>{ if(res.success) location.reload(); });
       });
  });

  document.getElementById('toggle-online-btn').addEventListener('click', () => {
       fetch('{{ url_for("nurse.toggle_online") }}', {
           method: 'POST', headers: {'X-CSRFToken': csrfToken}
       }).then(r=>r.json()).then(res=>{ if(res.success) location.reload(); });
  });

  document.addEventListener('DOMContentLoaded', () => {
      initMap();
      setInterval(loadRequests, 60000);
  });
</script>
{% endblock %}