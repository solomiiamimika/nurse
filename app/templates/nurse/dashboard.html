{% extends "base.html" %}
{% block content %}
<div class="nurse-dashboard">
    <h2>Панель медсестри</h2>
    
    <div class="dashboard-options" style="margin-bottom: 20px;">
        <form action="{{url_for('auth.logout')}}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-info">
                <i class="fas fa-sign-out-alt"></i> Вийти
            </button>
        </form>
        <a href="{{ url_for('nurse.appointments') }}" class="btn btn-info">
            <i class="fas fa-calendar"></i> Записи
        </a>
        <button id="location-btn" class="btn btn-info">
            <i class="fas fa-map-marker-alt"></i> Оновити моє місцезнаходження
        </button>
        <a href="{{ url_for('nurse.manage_services') }}" class="btn btn-info">
            <i class="fas fa-concierge-bell"></i> Мої послуги
        </a>
        <button
            id="toggle-online-btn"
            class="btn {{ 'btn-success' if current_user.online else 'btn-secondary' }}"
        >
            {{ 'Я онлайн' if current_user.online else 'Я офлайн' }}
        </button>
        <div id="status-message" class="mt-2 small"></div>
    </div>

    <div class="row">
        <!-- Карта (об'єднана функціональність) -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Карта клієнтів та запитів допомоги</h5>
                </div>
                <div class="card-body">
                    <div id="combinedMap" style="height: 500px; width: 100%;"></div>
                </div>
            </div>
        </div>
        
        <!-- Список запитів (нове) -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Доступні запити</h5>
                </div>
                <div class="card-body">
                    <div id="requestsList">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Завантаження...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальне вікно деталей запиту -->
<div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Деталі запиту</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Клієнт:</strong> <span id="detailPatientName"></span>
                </div>
                <div class="mb-3">
                    <strong>Послуга:</strong> <span id="detailServiceName"></span>
                </div>
                <div class="mb-3">
                    <strong>Опис послуги:</strong> <span id="detailServiceDescription"></span>
                </div>
                <div class="mb-3">
                    <strong>Бажаний час:</strong> <span id="detailDateTime"></span>
                </div>
                <div class="mb-3">
                    <strong>Примітки:</strong> <div id="detailNotes"></div>
                </div>
                <div class="mb-3">
                    <strong>Пропонована оплата:</strong> <span id="detailPayment"></span> UAH
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрити</button>
                <button type="button" class="btn btn-primary" id="acceptRequestBtn">Прийняти запит</button>
            </div>
        </div>
    </div>
</div>

<!-- Чат модальне вікно (як було) -->
<div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Чат з <span id="chatRecipientName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="chat-messages-container" id="chatMessages"></div>
                <div class="input-group">
                    <input type="text" class="form-control" id="messageInput" placeholder="Введіть повідомлення...">
                    <button class="btn btn-primary" type="button" id="sendMessageBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet для карти -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

<script>
let map;
let userMarker;
let clientsLayer = L.layerGroup();
let requestMarkers = [];
let socket;
let currentChatRecipient = null;
let currentRequestId = null;
const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
// Функції статусу (як було)
function showStatus(message, isError = false) {
    const statusEl = document.getElementById('status-message');
    statusEl.textContent = message;
    statusEl.style.color = isError ? 'red' : 'green';
    console.log(message);
}

// Socket функції (як було)
function initSocket() {
    socket = io();
    socket.on('connect', () => {
        console.log('Connected to Socket.IO server');
        socket.emit('join', { user_id: '{{ current_user.id }}' });
    });
    socket.on('new_message', (data) => {
        if (currentChatRecipient && currentChatRecipient.id === data.sender_id) {
            addMessageToChat(data, false);
        } else {
            showNewMessageNotification(data);
        }
    });
    socket.on('message_sent', (data) => {
        console.log('Message delivered:', data);
    });
    socket.on('error', (data) => {
        showStatus(data.message, true);
    });
}

function showNewMessageNotification(messageData) {
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show';
    notification.style.position = 'fixed';
    notification.style.bottom = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '1000';
    notification.innerHTML = `
        <strong>Нове повідомлення від ${messageData.sender_name}</strong>
        <p>${messageData.text}</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    setTimeout(() => { notification.remove(); }, 5000);
}

function openChatWithClient(client) {
    currentChatRecipient = client;
    document.getElementById('chatRecipientName').textContent = client.name;
    fetch(`{{ url_for('nurse.get_chat_messages') }}?recipient_id=${client.id}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(messages => {
        const chatContainer = document.getElementById('chatMessages');
        chatContainer.innerHTML = '';
        messages.forEach(msg => {
            addMessageToChat(msg, msg.sender_id === '{{ current_user.id }}');
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
    });
    const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
    chatModal.show();
}

function addMessageToChat(messageData, isMyMessage) {
    const chatContainer = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.className = `message ${isMyMessage ? 'my-message' : 'their-message'}`;
    const time = new Date(messageData.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    messageElement.innerHTML = `
        <div class="message-content">
            ${!isMyMessage ? `<div class="sender-name">${messageData.sender_name}</div>` : ''}
            <div class="message-text">${messageData.text}</div>
            <div class="message-time">${time}</div>
        </div>
    `;
    chatContainer.appendChild(messageElement);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Ініціалізація карти (об'єднана)
function initMap() {
    try {
        showStatus("Ініціалізація карти...");
        const nurseLat = {{ current_user.latitude if current_user.latitude is not none else 50.4501 }};
        const nurseLng = {{ current_user.longitude if current_user.longitude is not none else 30.5234}};
        
        map = L.map('combinedMap').setView([nurseLat, nurseLng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        clientsLayer.addTo(map);

        // Маркер медсестри (кружечок як було)
        if (nurseLat && nurseLng) {
            userMarker = L.marker([nurseLat, nurseLng], {
                icon: L.divIcon({
                    className: 'nurse-marker',
                    html: '<div style="background-color: purple; border-radius: 50%; width: 20px; height: 20px;"></div>',
                    iconSize: [20, 20]
                }),
                title: 'Ваше місцезнаходження'
            }).addTo(map).bindPopup('Ваше розташування').openPopup();
        }

        loadClientsLocations();
        loadRequests();

    } catch (error) {
        showStatus("Помилка ініціалізації карти: " + error.message, true);
        console.error(error);
    }
}

// Функції для клієнтів (як було)
async function loadClientsLocations() {
    try {
        showStatus("Завантаження клієнтів...");
        clientsLayer.clearLayers();

        const response = await fetch('{{ url_for("nurse.get_clients_locations") }}', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        if (!response.ok) throw new Error(`HTTP помилка! Статус: ${response.status}`);
        const clients = await response.json();

        clients.forEach(client => {
            const marker = L.marker([client.lat, client.lng], {
                icon: L.divIcon({
                    className: 'client-marker',
                    html: '<div style="background-color: blue; border-radius: 50%; width: 20px; height: 20px;"></div>',
                    iconSize: [20, 20]
                })
            }).addTo(clientsLayer);

            const popupContent = `
                <b>${client.name}</b>
                <button class="btn btn-sm btn-primary start-chat-btn"
                        data-client-id="${client.id}"
                        data-client-name="${client.name}">
                    <i class="fas fa-comment"></i> Написати
                </button>
            `;

            marker.bindPopup(popupContent);
            marker.on('popupopen', function() {
                const popup = marker.getPopup();
                const btn = popup.getElement().querySelector('.start-chat-btn');
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        openChatWithClient({
                            id: client.id,
                            name: client.name
                        });
                    });
                }
            });
        });

        showStatus(`Завантажено ${clients.length} клієнтів`);

    } catch (error) {
        showStatus("Помилка завантаження клієнтів: " + error.message, true);
        console.error("Помилка завантаження клієнтів:", error);
    }
}

// Функції для запитів (нове)
function loadRequests() {
    fetch('/nurse/nurse_get_requests')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRequests(data.requests);
                updateRequestMarkers(data.requests);
            } else {
                document.getElementById('requestsList').innerHTML = 
                    '<div class="alert alert-danger">Помилка завантаження запитів</div>';
            }
        })
        .catch(error => {
            console.error('Помилка:', error);
            document.getElementById('requestsList').innerHTML = 
                '<div class="alert alert-danger">Помилка завантаження запитів</div>';
        });
}

function displayRequests(requests) {
    const container = document.getElementById('requestsList');
    if (requests.length === 0) {
        container.innerHTML = '<div class="alert alert-info">Наразі немає доступних запитів</div>';
        return;
    }
    
    let html = '';
    requests.forEach(request => {
        const time = new Date(request.appointment_start_time).toLocaleString('uk-UA');
        html += `
            <div class="card mb-2 request-item" data-id="${request.id}">
                <div class="card-body">
                    <h6 class="card-title">${request.service_name || 'Послуга'}</h6>
                    <p class="card-text mb-1"><small>Клієнт: ${request.patient_name || 'Невідомо'}</small></p>
                    <p class="card-text mb-1"><small>Час: ${time}</small></p>
                    <p class="card-text"><small>Відстань: ${calculateDistance(request).toFixed(1)} км</small></p>
                    <button class="btn btn-sm btn-primary view-request-btn" data-id="${request.id}">Деталі</button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    document.querySelectorAll('.view-request-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const requestId = this.getAttribute('data-id');
            showRequestDetails(requestId, requests);
        });
    });
}

function updateRequestMarkers(requests) {
    requestMarkers.forEach(marker => map.removeLayer(marker));
    requestMarkers = [];
    
    requests.forEach(request => {
        if (request.latitude && request.longitude) {
            const marker = L.marker([request.latitude, request.longitude], {
                icon: L.divIcon({
                    className: 'request-marker',
                    html: '<div style="background-color: red; border-radius: 50%; width: 20px; height: 20px;"></div>',
                    iconSize: [20, 20]
                })
            }).addTo(map).bindPopup(`
                <strong>${request.service_name || 'Запит допомоги'}</strong><br>
                ${request.patient_name || 'Клієнт'}<br>
                <button onclick="showRequestDetails(${request.id})" class="btn btn-sm btn-primary mt-1">Деталі</button>
            `);
            requestMarkers.push(marker);
        }
    });
}

function showRequestDetails(requestId, requests = null) {
    if (!requests) {
        loadRequests();
        return;
    }
    
    const request = requests.find(r => r.id == requestId);
    if (!request) return;
    
    document.getElementById('detailPatientName').textContent = request.patient_name || 'Невідомо';
    document.getElementById('detailServiceName').textContent = request.service_name || 'Послуга';
    document.getElementById('detailServiceDescription').textContent = request.service_description || 'Немає опису';
    document.getElementById('detailDateTime').textContent = new Date(request.appointment_start_time).toLocaleString('uk-UA');
    document.getElementById('detailNotes').textContent = request.notes || 'Немає приміток';
    document.getElementById('detailPayment').textContent = request.payment || '0';
    
    currentRequestId = requestId;
    const modal = new bootstrap.Modal(document.getElementById('requestDetailsModal'));
    modal.show();
}

function acceptRequest(requestId) {
    fetch(`/nurse/nurse_accept_request/${requestId}`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrfToken}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Запит успішно прийнято!');
            bootstrap.Modal.getInstance(document.getElementById('requestDetailsModal')).hide();
            loadRequests();
        } else {
            alert('Помилка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Помилка:', error);
        alert('Сталася помилка');
    });
}

function calculateDistance(request) {
    const nurseLat = {{ current_user.latitude | default(50.4501) }};
    const nurseLng = {{ current_user.longitude | default(30.5234) }};
    
    if (!nurseLat || !nurseLng || !request.latitude || !request.longitude) return 0;
    
    const R = 6371;
    const dLat = (request.latitude - nurseLat) * Math.PI / 180;
    const dLng = (request.longitude - nurseLng) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(nurseLat * Math.PI / 180) * Math.cos(request.latitude * Math.PI / 180) * 
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Функції геолокації (як було)
async function updateLocation() {
    try {
        showStatus("Визначення вашого місцезнаходження...");
        if (!navigator.geolocation) throw new Error("Ваш браузер не підтримує геолокацію");

        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        });

        const {latitude, longitude} = position.coords;
        if (userMarker) map.removeLayer(userMarker);
        
        userMarker = L.marker([latitude, longitude], {
            icon: L.divIcon({
                className: 'nurse-marker',
                html: '<div style="background-color: purple; border-radius: 50%; width: 20px; height: 20px;"></div>',
                iconSize: [20, 20]
            }),
            title: 'Ваше місцезнаходження'
        }).addTo(map);
        
        map.setView([latitude, longitude], 12);

        const response = await fetch('{{ url_for("nurse.update_location") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json','X-CSRFToken': csrfToken},
            body: JSON.stringify({latitude: latitude, longitude: longitude})
        });

        if (!response.ok) throw new Error("Помилка сервера");
        const result = await response.json();
        if (!result.success) throw new Error(result.message || "Помилка оновлення");

        showStatus("Локація успішно оновлена");

    } catch (error) {
        showStatus("Помилка: " + error.message, true);
        console.error(error);
    }
}

async function toggleOnlineStatus() {
    try {
        const response = await fetch('{{ url_for("nurse.toggle_online") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json','X-CSRFToken': csrfToken}
        });

        if (!response.ok) throw new Error("Помилка сервера");
        const result = await response.json();
        if (!result.success) throw new Error("Помилка зміни статусу");

        const btn = document.getElementById('toggle-online-btn');
        if (result.online) {
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-success');
            btn.textContent = 'Я онлайн';
        } else {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            btn.textContent = 'Я офлайн';
        }

        showStatus("Статус оновлено: " + (result.online ? "онлайн" : "офлайн"));

    } catch (error) {
        showStatus("Помилка: " + error.message, true);
        console.error(error);
    }
}

// Ініціалізація
document.addEventListener('DOMContentLoaded', () => {
    initSocket();
    initMap();

    document.getElementById('location-btn').addEventListener('click', updateLocation);
    document.getElementById('toggle-online-btn').addEventListener('click', toggleOnlineStatus);
    document.getElementById('acceptRequestBtn').addEventListener('click', function() {
        if (!currentRequestId) return;
        acceptRequest(currentRequestId);
    });

    setInterval(loadClientsLocations, 30000);
    setInterval(loadRequests, 60000);

    document.getElementById('sendMessageBtn').addEventListener('click', () => {
        const messageText = document.getElementById('messageInput').value.trim();
        if (messageText && currentChatRecipient) {
            socket.emit('send_message', {
                text: messageText,
                sender_id: '{{ current_user.id }}',
                recipient_id: currentChatRecipient.id
            });
            addMessageToChat({
                sender_id: '{{ current_user.id }}',
                sender_name: 'Ви',
                text: messageText,
                timestamp: new Date().toISOString()
            }, true);
            document.getElementById('messageInput').value = '';
        }
    });
    
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('sendMessageBtn').click();
        }
    });
});
</script>

<style>
.request-item {
    cursor: pointer;
    transition: transform 0.2s;
}
.request-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
#combinedMap {
    border-radius: 8px;
}
.nurse-marker, .client-marker, .request-marker {
    z-index: 1000;
}
#status-message {
    min-height: 20px;
    font-size: 14px;
}
.chat-messages-container {
    height: 300px;
    overflow-y: auto;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 10px;
}
.message {
    margin-bottom: 10px;
    max-width: 80%;
    padding: 8px 12px;
    border-radius: 15px;
    position: relative;
}
.my-message {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 0;
}
.their-message {
    background-color: #e9ecef;
    margin-right: auto;
    border-bottom-left-radius: 0;
}
.message-content {
    display: flex;
    flex-direction: column;
}
.sender-name {
    font-weight: bold;
    font-size: 0.8em;
    margin-bottom: 3px;
}
.message-text {
    word-wrap: break-word;
}
.message-time {
    font-size: 0.7em;
    text-align: right;
    opacity: 0.7;
    margin-top: 3px;
}
.start-chat-btn {
    margin-top: 5px;
}
.dashboard-options {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}
</style>
{% endblock %}