<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>My Cool App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  </head>

  <body>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      <ul class="flashes">
        {% for category, message in messages %}
        <li class="alert alert-{{ category }}">{{ message }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    {% endwith %}
    
    {% block content %}{% endblock %}
    
    <!-- Чат модальне вікно -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="chatModalTitle">
              Чат з <span id="chatRecipientName"></span>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="chatMessages" class="chat-messages-container"></div>
            <div class="input-group mt-3">
              <input type="text" id="messageInput" class="form-control" placeholder="Введіть повідомлення..." />
              <button class="btn btn-primary" id="sendMessageBtn">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      window.currentUserId = "{{ current_user.id if current_user.is_authenticated else '' }}";
      window.currentUserRole = "{{ current_user.role if current_user.is_authenticated else '' }}";
      

      if (!window.socket) {
        window.socket = io("http://127.0.0.1:5000", {
          transports: ["websocket"],
          withCredentials: true
      });

        socket.on('connect', () => {
          console.log('Підключено до Socket.IO сервера');
          
          if (window.currentUserId) {
            socket.emit('join', { user_id: window.currentUserId });
          }
        });
        
        socket.on('new_message', (data) => {
          console.log('Отримано нове повідомлення:', data);
          if (data.sender_id.toString() === document.getElementById('chatModal').dataset.recipientId) {
            addMessageToChat(data, false);
          }
        });
        
        socket.on('message_sent', (data) => {
          console.log('Повідомлення доставлено:', data);
        });
        
        socket.on('error', (data) => {
          console.error('Помилка Socket.IO:', data.message);
        });
      }
      
      function openChat(recipientId, recipientName) {
        const modal = document.getElementById('chatModal');
        modal.dataset.recipientId = recipientId;
        document.getElementById('chatRecipientName').textContent = recipientName;
        
        fetch(`/${window.currentUserRole}/get_chat_messages?recipient_id=${recipientId}`)
          .then(response => response.json())
          .then(messages => {
            const chatContainer = document.getElementById('chatMessages');
            chatContainer.innerHTML = '';
            
            messages.forEach(msg => {
              addMessageToChat(msg, msg.sender_id.toString() === window.currentUserId);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
          });

        new bootstrap.Modal(modal).show();
      }

      function addMessageToChat(message, isSent) {
        const chatContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        messageDiv.innerHTML = `
          <div class="message-sender">${message.sender_name}</div>
          <div class="message-text">${message.text}</div>
          <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
        `;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      
      document.getElementById('sendMessageBtn').addEventListener('click', function() {
        const recipientId = document.getElementById('chatModal').dataset.recipientId;
        const messageInput = document.getElementById('messageInput');
        const messageText = messageInput.value.trim();
        
        if (messageText && recipientId && window.socket) {

          window.socket.emit('send_message', {
            sender_id: window.currentUserId,
            recipient: recipientId,
            text: messageText
          });
          
          addMessageToChat({
            sender_id: window.currentUserId,
            sender_name: 'Ви',
            text: messageText,
            timestamp: new Date().toISOString()
          }, true);
          
          messageInput.value = '';
        }
      });
    </script>
    
    {% block scripts %}{% endblock %}
  </body>
</html>